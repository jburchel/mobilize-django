{% extends 'base.html' %}
{% load static %}

{% block title %}Communications - Mobilize CRM{% endblock %}

{% block page_title %}Communications{% endblock %}

{% block page_actions %}
    <div class="d-flex gap-1 flex-wrap">
        <a href="{% url 'communications:gmail_compose' %}" class="btn btn-primary btn-sm px-2">
            <i class="fas fa-paper-plane"></i> Compose
        </a>
        <a href="{% url 'communications:native_sms_log' %}" class="btn btn-info btn-sm px-2">
            <i class="fas fa-mobile-alt"></i> SMS
        </a>
        <div class="btn-group">
            <button type="button" class="btn btn-success btn-sm dropdown-toggle px-2" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-plus-circle"></i> Log
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="openLogModal('Phone Call')">
                    <i class="fas fa-phone me-2"></i>Phone Call
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="openLogModal('Text Message')">
                    <i class="fas fa-sms me-2"></i>Text Message
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="openLogModal('Meeting')">
                    <i class="fas fa-users me-2"></i>Meeting
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="openLogModal('Video Call')">
                    <i class="fas fa-video me-2"></i>Video Call
                </a></li>
            </ul>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle px-2" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-cog"></i> Tools
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{% url 'communications:native_sms_log' %}">
                    <i class="fas fa-mobile-alt me-2"></i>SMS Logging
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'communications:email_template_list' %}">
                    <i class="fas fa-file-alt me-2"></i>Email Templates
                </a></li>
                <li><a class="dropdown-item" href="{% url 'communications:email_signature_list' %}">
                    <i class="fas fa-signature me-2"></i>Email Signatures
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="syncGmail()">
                    <i class="fas fa-sync me-2"></i>Sync Gmail
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="checkGmailStatus()">
                    <i class="fas fa-info-circle me-2"></i>Gmail Status
                </a></li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<!-- <link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}"> -->
<style>
    /* Communications container grid fix */
    #communications-container {
        display: flex !important;
        flex-wrap: wrap !important;
    }
    
    /* Force 3 columns on desktop (1200px+) */
    @media (min-width: 1200px) {
        #communications-container > .col-lg-4,
        #communications-container > .col-md-6 {
            flex: 0 0 auto;
            width: 33.333333% !important;
        }
    }
    
    /* 3 columns on large screens (992px+) */
    @media (min-width: 992px) and (max-width: 1199.98px) {
        #communications-container > .col-lg-4,
        #communications-container > .col-md-6 {
            flex: 0 0 auto;
            width: 33.333333% !important;
        }
    }
    
    /* 2 columns on medium screens (768px-991px) */
    @media (min-width: 768px) and (max-width: 991.98px) {
        #communications-container > .col-lg-4,
        #communications-container > .col-md-6 {
            flex: 0 0 auto;
            width: 50% !important;
        }
    }
    
    /* 1 column on small screens (below 768px) */
    @media (max-width: 767.98px) {
        #communications-container > .col-lg-4,
        #communications-container > .col-md-6 {
            width: 100% !important;
        }
    }
    
    .communication-card {
        transition: transform 0.2s ease-in-out;
        border-left: 4px solid transparent;
    }
    .communication-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .communication-card.email, .communication-card.Email {
        border-left-color: #007bff;
    }
    .communication-card.phone, .communication-card.Phone\ Call {
        border-left-color: #28a745;
    }
    .communication-card.text, .communication-card.Text\ Message {
        border-left-color: #17a2b8;
    }
    .communication-card.meeting, .communication-card.Meeting {
        border-left-color: #ffc107;
    }
    .communication-card.video_call, .communication-card.Video\ Call {
        border-left-color: #dc3545;
    }
    .direction-badge.inbound {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .direction-badge.outbound {
        background-color: #d4edda;
        color: #155724;
    }
    .status-badge {
        font-size: 0.75rem;
    }
    .filter-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
</style>
{% endblock %}

{% block content %}

<!-- Bulk Operations Bar -->
<div class="card mb-3" id="bulk-operations" style="display: none;">
    <div class="card-body py-2">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <span class="text-muted"><span id="selected-count">0</span> selected</span>
            
            <!-- Bulk Delete -->
            <form method="post" action="{% url 'communications:bulk_delete' %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete the selected communications?');">
                {% csrf_token %}
                <input type="hidden" name="communication_ids" id="bulk-delete-ids">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </form>
            
            <!-- Bulk Archive/Unarchive -->
            <form method="post" action="{% url 'communications:bulk_archive' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="communication_ids" id="bulk-archive-ids">
                <input type="hidden" name="archive_action" value="archive">
                <button type="submit" class="btn btn-warning btn-sm">
                    <i class="fas fa-archive"></i> Archive
                </button>
            </form>
            
            <form method="post" action="{% url 'communications:bulk_archive' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="communication_ids" id="bulk-unarchive-ids">
                <input type="hidden" name="archive_action" value="unarchive">
                <button type="submit" class="btn btn-outline-warning btn-sm">
                    <i class="fas fa-box-open"></i> Unarchive
                </button>
            </form>
            
            <!-- Bulk Status Update -->
            <form method="post" action="{% url 'communications:bulk_update_status' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="communication_ids" id="bulk-status-ids">
                <select name="status" class="form-select form-select-sm" style="width: auto; display: inline;">
                    <option value="">Change Status...</option>
                    {% for status_value, status_label in status_choices %}
                    <option value="{{ status_value }}">{{ status_label }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Update</button>
            </form>
            
            <!-- Bulk Type Update -->
            <form method="post" action="{% url 'communications:bulk_update_type' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="communication_ids" id="bulk-type-ids">
                <select name="type" class="form-select form-select-sm" style="width: auto; display: inline;">
                    <option value="">Change Type...</option>
                    {% for type_value, type_label in type_choices %}
                    <option value="{{ type_value }}">{{ type_label }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Update</button>
            </form>
        </div>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="card mb-3">
    <div class="card-body py-3">
        <!-- Search and Filter - UPDATED TO HORIZONTAL LAYOUT 2025-01-26 -->
        <form method="get">
            <!-- Mobile: stacked layout -->
            <div class="d-md-none">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="search-mobile" class="form-label">Search Communications</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control" id="search-mobile" name="search" 
                                   value="{{ request.GET.search }}" placeholder="Search communications..." autocomplete="off">
                        </div>
                    </div>
                    <div class="col-6">
                        <label for="type-mobile" class="form-label">Filter by Type</label>
                        <select class="form-select" id="type-mobile" name="type">
                            <option value="">All Types</option>
                            {% for type_value, type_label in type_choices %}
                                <option value="{{ type_value }}" {% if request.GET.type == type_value %}selected{% endif %}>
                                    {{ type_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6">
                        <label for="direction-mobile" class="form-label">Filter by Direction</label>
                        <select class="form-select" id="direction-mobile" name="direction">
                            <option value="">All Directions</option>
                            {% for direction_value, direction_label in direction_choices %}
                                <option value="{{ direction_value }}" {% if request.GET.direction == direction_value %}selected{% endif %}>
                                    {{ direction_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="status-mobile" class="form-label">Filter by Status</label>
                        <select class="form-select" id="status-mobile" name="status">
                            <option value="">All Status</option>
                            {% for status_value, status_label in status_choices %}
                                <option value="{{ status_value }}" {% if request.GET.status == status_value %}selected{% endif %}>
                                    {{ status_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                            <a href="{% url 'communications:communication_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Clear
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Desktop: single line layout -->
            <div class="d-none d-md-flex align-items-center gap-2 flex-nowrap">
                <div class="input-group" style="min-width: 200px; flex: 1;">
                    <span class="input-group-text bg-light">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" name="search" class="form-control" id="search-input" placeholder="Search communications..." 
                           value="{{ request.GET.search }}" autocomplete="off">
                </div>
                <select name="type" class="form-select" style="min-width: 120px; width: auto;" onchange="this.form.submit()">
                    <option value="">All Types</option>
                    {% for type_value, type_label in type_choices %}
                        <option value="{{ type_value }}" {% if request.GET.type == type_value %}selected{% endif %}>
                            {{ type_label }}
                        </option>
                    {% endfor %}
                </select>
                <select name="direction" class="form-select" style="min-width: 130px; width: auto;" onchange="this.form.submit()">
                    <option value="">All Directions</option>
                    {% for direction_value, direction_label in direction_choices %}
                        <option value="{{ direction_value }}" {% if request.GET.direction == direction_value %}selected{% endif %}>
                            {{ direction_label }}
                        </option>
                    {% endfor %}
                </select>
                <select name="status" class="form-select" style="min-width: 120px; width: auto;" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    {% for status_value, status_label in status_choices %}
                        <option value="{{ status_value }}" {% if request.GET.status == status_value %}selected{% endif %}>
                            {{ status_label }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary px-3">
                    <i class="fas fa-search"></i>
                </button>
                <a href="{% url 'communications:communication_list' %}" class="btn btn-outline-secondary px-3">
                    <i class="fas fa-times"></i>
                </a>
            </div>
            
            <!-- Keep other parameters when changing filters -->
            {% if current_view_mode %}
                <input type="hidden" name="view_mode" value="{{ current_view_mode }}">
            {% endif %}
        </form>
    </div>
</div>

<!-- Communications List -->
<div class="w-100">
    <div class="row g-3" id="communications-container">
        <!-- Communications will be loaded dynamically by LazyLoader -->
    </div>
    
    <!-- No Results Message -->
    <div id="no-results" class="text-center text-muted py-4" style="display: none;">
        <i class="fas fa-envelope fa-4x text-muted mb-4"></i>
        <h4 class="text-muted">No Communications Found</h4>
        <p class="text-muted mb-4">Start by composing your first email or sync your Gmail account.</p>
        <div class="d-flex justify-content-center gap-2">
            <a href="{% url 'communications:gmail_compose' %}" class="btn btn-primary">
                <i class="fas fa-paper-plane me-2"></i>Compose Email
            </a>
            <a href="{% url 'communications:native_sms_log' %}" class="btn btn-info">
                <i class="fas fa-mobile-alt me-2"></i>Log SMS
            </a>
            <button class="btn btn-outline-info" onclick="syncGmail()">
                <i class="fas fa-sync me-2"></i>Sync Gmail
            </button>
        </div>
    </div>
    
    <!-- Pagination Status and Load More Button -->
    <div class="d-flex justify-content-between align-items-center mt-3" id="pagination-controls">
        <div class="text-muted">
            <span id="showing-text">Showing <span id="current-count">0</span> of <span id="total-count">0</span> communications</span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <label for="per-page-select" class="form-label mb-0 text-muted">Show:</label>
                <select id="per-page-select" class="form-select form-select-sm" style="width: auto;">
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div>
                <button type="button" class="btn btn-primary" id="load-more-btn" style="display: none;">
                    Load More <span id="per-page-count">25</span>
                </button>
                <span class="text-muted" id="end-reached" style="display: none;">
                    <i class="fas fa-check-circle text-success"></i> All communications loaded
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Log Communication Modal -->
<div class="modal fade" id="logCommunicationModal" tabindex="-1" aria-labelledby="logCommunicationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logCommunicationModalLabel">Log Communication</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="logCommunicationForm" method="post" action="{% url 'communications:communication_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="communicationType" name="type" value="">
                    
                    <!-- Subject/Title -->
                    <div class="mb-3">
                        <label for="communicationSubject" class="form-label">Subject/Title</label>
                        <input type="text" class="form-control" id="communicationSubject" name="subject" required>
                    </div>
                    
                    <!-- Contact Selection -->
                    <div class="mb-3">
                        <label class="form-label">Related Contact</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="personSelect" class="form-label">Person</label>
                                <select class="form-select" id="personSelect" name="person">
                                    <option value="">Select Person...</option>
                                    <!-- This would be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="churchSelect" class="form-label">Church</label>
                                <select class="form-select" id="churchSelect" name="church">
                                    <option value="">Select Church...</option>
                                    <!-- This would be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Direction -->
                    <div class="mb-3">
                        <label class="form-label">Direction</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="direction" id="directionInbound" value="inbound" checked>
                            <label class="form-check-label" for="directionInbound">
                                Inbound (They contacted me)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="direction" id="directionOutbound" value="outbound">
                            <label class="form-check-label" for="directionOutbound">
                                Outbound (I contacted them)
                            </label>
                        </div>
                    </div>
                    
                    <!-- Date and Time -->
                    <div class="mb-3">
                        <label for="communicationDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="communicationDate" name="date" required>
                    </div>
                    
                    <!-- Video Call Options (only shown for video_call type) -->
                    <div class="mb-3" id="videoCallOptions" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Google Meet Integration</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="meetOption" id="noMeetLink" value="none" checked>
                                    <label class="form-check-label" for="noMeetLink">
                                        No Meet Link (just log the call)
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="meetOption" id="createInstantMeet" value="instant">
                                    <label class="form-check-label" for="createInstantMeet">
                                        Create Instant Meet Link (starts now)
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="meetOption" id="scheduleForLater" value="scheduled">
                                    <label class="form-check-label" for="scheduleForLater">
                                        Schedule for Later
                                    </label>
                                </div>
                                
                                <!-- Scheduled meeting options -->
                                <div id="scheduledMeetOptions" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="meetDateTime" class="form-label">Date & Time</label>
                                            <input type="datetime-local" class="form-control" id="meetDateTime" name="meet_datetime">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="meetDuration" class="form-label">Duration (minutes)</label>
                                            <input type="number" class="form-control" id="meetDuration" name="meet_duration" value="60" min="15" max="480">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="communicationNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="communicationNotes" name="message" rows="4" required 
                                  placeholder="Enter details about the communication..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Communication</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Status Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Status</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="statusToastBody">
            <!-- Toast content will be inserted here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/lazy-loading.js' %}?v=1750793997"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize toast
    const statusToast = new bootstrap.Toast(document.getElementById('statusToast'));
    
    // Bulk operations management
    const selectAllCheckbox = document.getElementById('select-all');
    const communicationCheckboxes = document.querySelectorAll('.communication-checkbox');
    const bulkOperationsBar = document.getElementById('bulk-operations');
    const selectedCountSpan = document.getElementById('selected-count');
    
    // Handle select all functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            communicationCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkOperations();
        });
    }
    
    // Handle individual checkbox changes
    communicationCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkOperations();
            updateSelectAllState();
        });
    });
    
    function updateBulkOperations() {
        const checkedBoxes = document.querySelectorAll('.communication-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (count > 0) {
            bulkOperationsBar.classList.add('show');
            selectedCountSpan.textContent = count;
            
            // Update all hidden communication_ids inputs
            const communicationIds = Array.from(checkedBoxes).map(cb => cb.value).join(',');
            document.getElementById('bulk-delete-ids').value = communicationIds;
            document.getElementById('bulk-archive-ids').value = communicationIds;
            document.getElementById('bulk-unarchive-ids').value = communicationIds;
            document.getElementById('bulk-status-ids').value = communicationIds;
            document.getElementById('bulk-type-ids').value = communicationIds;
            document.getElementById('bulk-user-ids').value = communicationIds;
        } else {
            bulkOperationsBar.classList.remove('show');
        }
    }
    
    function updateSelectAllState() {
        const checkedCount = document.querySelectorAll('.communication-checkbox:checked').length;
        const totalCount = communicationCheckboxes.length;
        
        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === totalCount) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // Legacy form-based search removed - now using LazyLoader dynamic search
    
    // Load contacts for dropdowns
    loadContactsForDropdowns();
    
    // Check for URL parameters to auto-open modal
    const urlParams = new URLSearchParams(window.location.search);
    const openLogModal = urlParams.get('open_log_modal');
    const contactId = urlParams.get('contact_id');
    
    if (openLogModal) {
        setTimeout(() => {
            openLogModalByType(openLogModal);
            if (contactId) {
                // Pre-select the contact when modal opens
                preSelectContact(contactId);
            }
        }, 500); // Delay to ensure dropdowns are loaded
    }
});

function loadContactsForDropdowns() {
    fetch('{% url "communications:get_contacts_json" %}')
    .then(response => response.json())
    .then(data => {
        // Populate person dropdown
        const personSelect = document.getElementById('personSelect');
        personSelect.innerHTML = '<option value="">Select Person...</option>';
        data.people.forEach(person => {
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = person.name;
            personSelect.appendChild(option);
        });
        
        // Populate church dropdown
        const churchSelect = document.getElementById('churchSelect');
        churchSelect.innerHTML = '<option value="">Select Church...</option>';
        data.churches.forEach(church => {
            const option = document.createElement('option');
            option.value = church.id;
            option.textContent = church.name;
            churchSelect.appendChild(option);
        });
    })
    .catch(error => {
        console.error('Error loading contacts:', error);
    });
}

function showToast(message, type = 'info') {
    const toastBody = document.getElementById('statusToastBody');
    const toast = bootstrap.Toast.getOrCreateInstance(document.getElementById('statusToast'));
    
    toastBody.innerHTML = message;
    toast.show();
}

function syncGmail() {
    showToast('Syncing Gmail messages...', 'info');
    
    fetch('{% url "communications:gmail_sync" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'days_back=7'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Successfully synced ${data.synced_count} emails.`, 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showToast(`Sync failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast('Error syncing Gmail. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function checkGmailStatus() {
    fetch('{% url "communications:gmail_status" %}')
    .then(response => response.json())
    .then(data => {
        if (data.authenticated) {
            showToast(`Gmail connected for ${data.user_email}`, 'success');
        } else {
            showToast('Gmail not connected. Please authorize Gmail access.', 'warning');
        }
    })
    .catch(error => {
        showToast('Error checking Gmail status.', 'error');
        console.error('Error:', error);
    });
}

function openLogModal(type) {
    const modal = new bootstrap.Modal(document.getElementById('logCommunicationModal'));
    const typeInput = document.getElementById('communicationType');
    const modalTitle = document.getElementById('logCommunicationModalLabel');
    const videoCallOptions = document.getElementById('videoCallOptions');
    
    // Set the communication type
    typeInput.value = type;
    
    // Update modal title based on type
    const typeLabels = {
        'Phone Call': 'Log Phone Call',
        'Text Message': 'Log Text Message',
        'Meeting': 'Log Meeting',
        'Video Call': 'Log Video Call'
    };
    modalTitle.textContent = typeLabels[type] || 'Log Communication';
    
    // Show/hide video call options
    if (type === 'Video Call') {
        videoCallOptions.style.display = 'block';
    } else {
        videoCallOptions.style.display = 'none';
    }
    
    // Set today's date as default
    const dateInput = document.getElementById('communicationDate');
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
    
    // Show the modal
    modal.show();
}

// Alias for URL parameter handling
function openLogModalByType(type) {
    openLogModal(type);
}

// Pre-select contact in modal dropdowns
function preSelectContact(contactId) {
    // First, try to find the contact in people dropdown
    const personSelect = document.getElementById('personSelect');
    if (personSelect) {
        for (let option of personSelect.options) {
            if (option.value == contactId) {
                option.selected = true;
                return;
            }
        }
    }
    
    // If not found in people, try churches dropdown
    const churchSelect = document.getElementById('churchSelect');
    if (churchSelect) {
        for (let option of churchSelect.options) {
            if (option.value == contactId) {
                option.selected = true;
                return;
            }
        }
    }
}

// Handle Meet option changes
document.addEventListener('DOMContentLoaded', function() {
    const scheduledOptions = document.getElementById('scheduledMeetOptions');
    const meetOptionRadios = document.querySelectorAll('input[name="meetOption"]');
    
    meetOptionRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'scheduled') {
                scheduledOptions.style.display = 'block';
                // Set default datetime to 1 hour from now
                const now = new Date();
                now.setHours(now.getHours() + 1);
                const datetimeString = now.toISOString().slice(0, 16);
                document.getElementById('meetDateTime').value = datetimeString;
            } else {
                scheduledOptions.style.display = 'none';
            }
        });
    });
    
    // Dynamic search handled by LazyLoader implementation below
});

// Handle form submission
document.getElementById('logCommunicationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const type = formData.get('type');
    
    // Add user_id field
    formData.append('user_id', '{{ request.user.id }}');
    
    // Handle Meet link creation for video calls
    if (type === 'Video Call') {
        const meetOption = formData.get('meetOption');
        
        if (meetOption === 'instant' || meetOption === 'scheduled') {
            // First create the Meet link, then save the communication
            createMeetLinkThenSave(formData);
            return;
        }
    }
    
    // Regular communication save
    saveCommunication(formData);
});

function createMeetLinkThenSave(formData) {
    const meetOption = formData.get('meetOption');
    const title = formData.get('subject') || 'Video Call';
    
    let meetData = {
        meetOption: meetOption,
        title: title,
        duration: parseInt(formData.get('meet_duration')) || 60
    };
    
    if (meetOption === 'scheduled') {
        const meetDateTime = formData.get('meet_datetime');
        if (!meetDateTime) {
            showToast('Please select a date and time for the scheduled meeting.', 'error');
            return;
        }
        meetData.start_datetime = meetDateTime;
    }
    
    // Add related contact info for invitations
    const personId = formData.get('person');
    const churchId = formData.get('church');
    if (personId) meetData.person_id = personId;
    if (churchId) meetData.church_id = churchId;
    
    showToast('Creating Google Meet link...', 'info');
    
    fetch('{% url "communications:create_meet_link" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(meetData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add Meet link info to the communication
            formData.append('google_meet_link', data.meet_link);
            formData.append('google_calendar_event_id', data.event_id);
            
            // Update the message to include Meet link
            const currentMessage = formData.get('message') || '';
            const meetInfo = `\n\nGoogle Meet Link: ${data.meet_link}`;
            formData.set('message', currentMessage + meetInfo);
            
            showToast('Meet link created! Saving communication...', 'success');
            saveCommunication(formData);
        } else {
            showToast(`Error creating Meet link: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast('Error creating Meet link. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function saveCommunication(formData) {
    fetch(document.getElementById('logCommunicationForm').action, {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        },
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showToast('Communication logged successfully!', 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('Error logging communication. Please try again.', 'error');
        }
    })
    .catch(error => {
        showToast('Error logging communication. Please try again.', 'error');
        console.error('Error:', error);
    });
}

// Initialize LazyLoader for communications
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing communication loader...');
    
    // Check if required elements exist
    const communicationsContainer = document.getElementById('communications-container');
    console.log('Communications container element:', communicationsContainer);
    
    if (!communicationsContainer) {
        console.error('ERROR: communications-container element not found!');
        return;
    }
    
    // Initialize lazy loader for communications (keeping cards format)
    const communicationLoader = new LazyLoader({
        tableBody: communicationsContainer, // Target the card container
        apiUrl: '{% url "communications:communication_list_api" %}',
        perPage: 25,
        enableInfiniteScroll: false,
        filters: {
            search: '{{ request.GET.search|default:"" }}',
            type: '{{ request.GET.type|default:"" }}',
            direction: '{{ request.GET.direction|default:"" }}',
            status: '{{ request.GET.status|default:"" }}',
            sort: '{{ request.GET.sort|default:"" }}'
        }
    });
    
    console.log('LazyLoader initialized:', communicationLoader);
    console.log('API URL:', '{% url "communications:communication_list_api" %}');
    
    // Override createRow method to work with card divs instead of table rows
    communicationLoader.createRow = function(item) {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'col-12 col-md-6 col-lg-4 mb-3';
        
        // Let Bootstrap handle responsive widths - remove conflicting inline styles
        cardDiv.innerHTML = this.getRowTemplate(item);
        console.log('DEBUG: Created card div with classes:', cardDiv.className);
        return cardDiv;
    };
    
    // Override renderRows method to work without sentinel for card grid
    communicationLoader.renderRows = function(items) {
        const fragment = document.createDocumentFragment();
        
        items.forEach(item => {
            const row = this.createRow(item);
            fragment.appendChild(row);
        });
        
        // Append directly to container (no sentinel needed for cards)
        this.tableBody.appendChild(fragment);
        
        // Update current count based on items actually rendered
        this.currentCount += items.length;
        
        // Update bulk selection handlers
        this.updateBulkSelectionHandlers();
    };
    
    // Override resetAndLoad method to work with card container
    communicationLoader.resetAndLoad = function() {
        // Clear existing cards
        this.tableBody.innerHTML = '';
        
        // Reset pagination
        this.currentPage = 1;
        this.hasMore = true;
        this.totalCount = 0;
        this.currentCount = 0;
        
        // Load first page
        this.loadMore();
    };
    
    // Override updateBulkSelectionHandlers for card checkboxes
    communicationLoader.updateBulkSelectionHandlers = function() {
        // Re-initialize bulk selection handlers for new checkboxes
        const newCheckboxes = this.tableBody.querySelectorAll('.communication-checkbox:not([data-initialized])');
        newCheckboxes.forEach(checkbox => {
            checkbox.setAttribute('data-initialized', 'true');
            checkbox.addEventListener('change', () => {
                if (window.updateBulkOperations) {
                    window.updateBulkOperations();
                }
            });
        });
    };
    
    // Override updatePaginationDisplay for communications
    communicationLoader.updatePaginationDisplay = function() {
        // Update pagination counts in the UI
        const currentCountSpan = document.getElementById('current-count');
        const totalCountSpan = document.getElementById('total-count');
        
        console.log('Communication Loader: Updating pagination display - current:', this.currentCount, 'total:', this.totalCount);
        
        if (currentCountSpan) {
            currentCountSpan.textContent = this.currentCount;
        }
        
        if (totalCountSpan) {
            totalCountSpan.textContent = this.totalCount;
        }
        
        // Show no results message if no communications
        const noResults = document.getElementById('no-results');
        if (this.totalCount === 0 && this.currentCount === 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
        
        // Update load more button visibility (only if infinite scroll is disabled)
        if (!this.enableInfiniteScroll) {
            const loadMoreBtn = document.getElementById('load-more-btn');
            const endReachedSpan = document.getElementById('end-reached');
            
            if (loadMoreBtn && endReachedSpan) {
                if (this.hasMore && this.currentCount > 0) {
                    loadMoreBtn.style.display = 'inline-block';
                    endReachedSpan.style.display = 'none';
                } else {
                    loadMoreBtn.style.display = 'none';
                    if (this.currentCount >= this.totalCount && this.totalCount > 0) {
                        endReachedSpan.style.display = 'inline-block';
                    }
                }
            }
        }
    };

    // Override the row template for communication card rendering
    communicationLoader.getRowTemplate = function(item) {
        // Format date with better error handling
        let date, dateDisplay, timeSince;
        
        try {
            // The API returns pre-formatted date string, use it directly
            if (item.date && item.date !== "No date") {
                // Extract just the date part (before " at ") for display
                const datePart = item.date.split(' at ')[0];
                dateDisplay = datePart;
                
                // For time calculation, try to parse the full date string
                date = new Date(item.date);
                if (!isNaN(date.getTime())) {
                    const now = new Date();
                    const diffTime = Math.abs(now - date);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    timeSince = diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;
                } else {
                    timeSince = 'Recently';
                }
            } else {
                throw new Error('No date available');
            }
            
        } catch (error) {
            console.warn('Date parsing failed for item:', item, error);
            dateDisplay = 'No date';
            timeSince = 'Recently';
        }

        return `
            <div class="card communication-card ${this.getTypeClass(item.type)} h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <input type="checkbox" name="communication_ids" value="${item.id}" class="form-check-input communication-checkbox me-3">
                        ${this.getTypeIcon(item.type)}
                        <span class="badge direction-badge ${item.direction}">
                            ${item.direction || 'Unknown'}
                        </span>
                    </div>
                    <small class="text-muted">${dateDisplay}</small>
                </div>
                <div class="card-body">
                    <h6 class="card-title mb-2">${item.subject || 'No Subject'}</h6>
                    ${item.sender ? `<div class="mb-2"><small class="text-muted"><i class="fas fa-user me-1"></i>${item.sender}</small></div>` : ''}
                    ${item.message ? `<p class="card-text text-muted small">${item.message.substring(0, 100)}${item.message.length > 100 ? '...' : ''}</p>` : ''}
                    ${item.contact_name ? `<div class="mb-2"><span class="badge bg-light text-dark"><i class="${item.contact_icon} me-1"></i>${item.contact_name}</span></div>` : ''}
                </div>
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${timeSince}</small>
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="${item.detail_url}" class="btn btn-outline-primary btn-sm" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="${item.edit_url}" class="btn btn-outline-info btn-sm" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="${item.delete_url}" class="btn btn-outline-danger btn-sm" title="Delete">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    };
    
    // Add getTypeClass method for styling cards by type
    communicationLoader.getTypeClass = function(type) {
        const typeClasses = {
            'Email': 'email',
            'email': 'email',
            'Phone Call': 'phone',
            'phone': 'phone',
            'Text Message': 'text',
            'text': 'text', 
            'Meeting': 'meeting',
            'meeting': 'meeting',
            'Video Call': 'video_call',
            'video_call': 'video_call'
        };
        return typeClasses[type] || '';
    };
    
    // Add getTypeIcon method
    communicationLoader.getTypeIcon = function(type) {
        const icons = {
            'Email': '<i class="fas fa-envelope text-primary me-2"></i>',
            'email': '<i class="fas fa-envelope text-primary me-2"></i>',
            'Phone Call': '<i class="fas fa-phone text-success me-2"></i>',
            'phone': '<i class="fas fa-phone text-success me-2"></i>',
            'Text Message': '<i class="fas fa-sms text-info me-2"></i>',
            'text': '<i class="fas fa-sms text-info me-2"></i>',
            'Meeting': '<i class="fas fa-users text-warning me-2"></i>',
            'meeting': '<i class="fas fa-users text-warning me-2"></i>',
            'Video Call': '<i class="fas fa-video text-danger me-2"></i>',
            'video_call': '<i class="fas fa-video text-danger me-2"></i>'
        };
        return icons[type] || '<i class="fas fa-sticky-note text-secondary me-2"></i>';
    };
    
    // Bulk operations management
    const selectAll = document.getElementById('select-all');
    const bulkOpsBar = document.getElementById('bulk-operations');
    const selectedCount = document.getElementById('selected-count');
    
    window.updateBulkOperations = function() {
        const checkboxes = document.querySelectorAll('.communication-checkbox');
        const selected = document.querySelectorAll('.communication-checkbox:checked');
        const count = selected.length;
        
        selectedCount.textContent = count;
        if (count > 0) {
            bulkOpsBar.classList.add('show');
        } else {
            bulkOpsBar.classList.remove('show');
        }
        
        // Update hidden inputs for bulk operations
        const ids = Array.from(selected).map(cb => cb.value).join(',');
        document.getElementById('bulk-delete-ids').value = ids;
        document.getElementById('bulk-archive-ids').value = ids;
        document.getElementById('bulk-status-ids').value = ids;
        document.getElementById('bulk-type-ids').value = ids;
        document.getElementById('bulk-user-ids').value = ids;
        
        // Update select all checkbox state
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        const noneChecked = Array.from(checkboxes).every(cb => !cb.checked);
        
        selectAll.checked = allChecked;
        selectAll.indeterminate = !allChecked && !noneChecked;
    };
    
    // Select all functionality
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.communication-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateBulkOperations();
        });
    }
    
    // Dynamic search functionality
    function updateFilters() {
        const searchInput = document.getElementById('main-search-input');
        const typeFilter = document.getElementById('quick-type-filter');
        const directionFilter = document.getElementById('quick-direction-filter');  
        const statusFilter = document.getElementById('quick-status-filter');
        
        console.log('DEBUG: updateFilters called');
        console.log('DEBUG: searchInput value:', searchInput ? searchInput.value : 'not found');
        console.log('DEBUG: communicationLoader:', communicationLoader);
        
        communicationLoader.updateFilters({
            search: searchInput ? searchInput.value : '',
            type: typeFilter ? typeFilter.value : '',
            direction: directionFilter ? directionFilter.value : '',
            status: statusFilter ? statusFilter.value : '',
            sort: ''
        });
        communicationLoader.resetAndLoad();
    }
    
    // Add event listeners for search and filters
    const mainSearchInput = document.getElementById('main-search-input');
    console.log('DEBUG: mainSearchInput element:', mainSearchInput);
    if (mainSearchInput) {
        console.log('DEBUG: Setting up event listeners for search');
        // Debounce function for dynamic search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        mainSearchInput.addEventListener('input', debounce(function() {
            console.log('DEBUG: Input event triggered');
            updateFilters();
        }, 300));
        mainSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                console.log('DEBUG: Enter key pressed');
                e.preventDefault();
                updateFilters();
            }
        });
    } else {
        console.log('DEBUG: mainSearchInput element not found!');
    }
    
    // Add event listeners to filter dropdowns
    ['quick-type-filter', 'quick-direction-filter', 'quick-status-filter'].forEach(filterId => {
        const filter = document.getElementById(filterId);
        if (filter) {
            filter.addEventListener('change', updateFilters);
        }
    });
    
    // Set up pagination controls
    const loadMoreBtn = document.getElementById('load-more-btn');
    const currentCountSpan = document.getElementById('current-count');
    const totalCountSpan = document.getElementById('total-count');
    const endReachedSpan = document.getElementById('end-reached');
    const perPageSelect = document.getElementById('per-page-select');
    const perPageCount = document.getElementById('per-page-count');
    
    // Load more button click handler (only if infinite scroll is disabled)
    if (!communicationLoader.enableInfiniteScroll) {
        loadMoreBtn.addEventListener('click', () => {
            communicationLoader.loadMore();
        });
    }
    
    // Per-page selector change handler
    perPageSelect.addEventListener('change', (e) => {
        const newPerPage = parseInt(e.target.value);
        communicationLoader.perPage = newPerPage;
        perPageCount.textContent = newPerPage;
        communicationLoader.resetAndLoad();
    });
    
    // Load initial data
    console.log('About to call loadMore()...');
    try {
        communicationLoader.loadMore();
        console.log('loadMore() called successfully');
    } catch (error) {
        console.error('loadMore() failed:', error);
    }
    
    // Dynamic Search Functionality
    const searchInput = document.getElementById('search-input');
    const searchMobile = document.getElementById('search-mobile');
    const typeSelects = document.querySelectorAll('select[name="type"]');
    const directionSelects = document.querySelectorAll('select[name="direction"]');
    const statusSelects = document.querySelectorAll('select[name="status"]');
    
    // Debounce function for dynamic search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function updateCommFilters() {
        // Get the active search input value
        const searchQuery = searchInput ? searchInput.value : (searchMobile ? searchMobile.value : '');
        let type = '';
        let direction = '';
        let status = '';
        
        // Find visible selects
        typeSelects.forEach(select => {
            if (select.offsetParent !== null) type = select.value;
        });
        directionSelects.forEach(select => {
            if (select.offsetParent !== null) direction = select.value;
        });
        statusSelects.forEach(select => {
            if (select.offsetParent !== null) status = select.value;
        });
        
        console.log('Dynamic communication search:', { searchQuery, type, direction, status });
        
        communicationLoader.updateFilters({
            search: searchQuery,
            type: type,
            direction: direction,
            status: status
        });
        
        // Reset and reload data with new filters
        communicationLoader.resetAndLoad();
    }
    
    // Add dynamic search to inputs
    if (searchInput) {
        searchInput.addEventListener('input', debounce(updateCommFilters, 300));
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                updateCommFilters();
            }
        });
    }
    
    if (searchMobile) {
        searchMobile.addEventListener('input', debounce(updateCommFilters, 300));
        searchMobile.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                updateCommFilters();
            }
        });
    }
    
    // Remove onchange submit and add dynamic filtering
    typeSelects.forEach(select => {
        select.removeAttribute('onchange');
        select.addEventListener('change', updateCommFilters);
    });
    
    directionSelects.forEach(select => {
        select.removeAttribute('onchange');
        select.addEventListener('change', updateCommFilters);
    });
    
    statusSelects.forEach(select => {
        select.removeAttribute('onchange');
        select.addEventListener('change', updateCommFilters);
    });
});
</script>
{% endblock %}