{% extends 'base.html' %}
{% load static %}

{% block title %}{{ person.name }}{% endblock %}

{% block page_title %}{{ person.name }}{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <!-- Communication Actions Dropdown -->
    <div class="btn-group me-2" role="group">
        <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-plus-circle me-2"></i>Log Communication
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{% url 'communications:gmail_compose' %}?recipient={{ person.contact.email }}&name={{ person.name }}&contact_id={{ person.contact.id }}">
                <i class="fas fa-envelope me-2"></i>Send Email
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="openLogModal('phone', '{{ person.pk }}', '{{ person.name }}')">
                <i class="fas fa-phone me-2"></i>Log Phone Call
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="openLogModal('text', '{{ person.pk }}', '{{ person.name }}')">
                <i class="fas fa-sms me-2"></i>Log Text Message
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="openLogModal('meeting', '{{ person.pk }}', '{{ person.name }}')">
                <i class="fas fa-users me-2"></i>Log Meeting
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="openLogModal('video_call', '{{ person.pk }}', '{{ person.name }}')">
                <i class="fas fa-video me-2"></i>Log Video Call
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="openLogModal('other', '{{ person.pk }}', '{{ person.name }}')">
                <i class="fas fa-comment-dots me-2"></i>Log Other
            </a></li>
        </ul>
    </div>
    
    <a href="{% url 'contacts:person_edit' person.pk %}" class="btn btn-primary">
        <i class="fas fa-edit"></i> Edit
    </a>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-ellipsis-v"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="/communications/?contact_id={{ person.contact.id }}">
                <i class="fas fa-comment-alt me-2"></i> View Communications
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="{% url 'contacts:person_delete' person.pk %}">
                <i class="fas fa-trash me-2"></i> Delete Person
            </a></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .info-card {
        border-left: 4px solid #007bff;
        transition: transform 0.2s ease-in-out;
    }
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .contact-card {
        border-left: 4px solid #28a745;
    }
    .personal-card {
        border-left: 4px solid #6f42c1;
    }
    .professional-card {
        border-left: 4px solid #fd7e14;
    }
    .church-card {
        border-left: 4px solid #dc3545;
    }
    .activity-card {
        border-left: 4px solid #20c997;
    }
    .pipeline-highlight {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        margin-bottom: 1.5rem;
    }
    .field-row {
        border-bottom: 1px solid #f8f9fa;
        padding: 0.75rem 0;
    }
    .field-row:last-child {
        border-bottom: none;
    }
    .field-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
        display: block;
    }
    .field-value {
        color: #212529;
        font-size: 0.9rem;
    }
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    .social-link {
        margin-bottom: 0.5rem;
    }
    
    /* Pipeline Slider Styles */
    .pipeline-slider {
        padding: 1rem 0;
    }
    
    .pipeline-track {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        margin: 0 2rem;
    }
    
    .pipeline-stage {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        z-index: 2;
    }
    
    .pipeline-stage:hover {
        transform: translateY(-3px);
    }
    
    .stage-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 3px solid rgba(255, 255, 255, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .pipeline-stage.active .stage-circle {
        background: #28a745;
        border-color: #28a745;
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.6);
        transform: scale(1.1);
    }
    
    .pipeline-stage:hover .stage-circle {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.6);
        transform: scale(1.05);
    }
    
    .stage-number {
        font-weight: bold;
        font-size: 1.1rem;
        color: white;
    }
    
    .pipeline-stage.active .stage-number {
        color: white;
        font-weight: 900;
    }
    
    .stage-label {
        color: white;
        font-size: 0.85rem;
        font-weight: 500;
        text-align: center;
        min-width: 80px;
        opacity: 0.9;
    }
    
    .pipeline-stage.active .stage-label {
        opacity: 1;
        font-weight: 700;
        color: #28a745;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    .pipeline-connector {
        flex: 1;
        height: 3px;
        background: rgba(255, 255, 255, 0.3);
        margin: 0 1rem;
        position: relative;
        top: -25px;
        z-index: 1;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .pipeline-track {
            margin: 0 1rem;
        }
        
        .stage-circle {
            width: 40px;
            height: 40px;
        }
        
        .stage-number {
            font-size: 1rem;
        }
        
        .stage-label {
            font-size: 0.75rem;
            min-width: 60px;
        }
        
        .pipeline-connector {
            margin: 0 0.5rem;
            top: -20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hidden form for CSRF token -->
<form style="display: none;">
    {% csrf_token %}
</form>

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Interactive Pipeline Stage Slider -->
        <div class="card pipeline-highlight">
            <div class="card-body">
                <h5 class="card-title text-white mb-3 text-center">
                    <i class="fas fa-flag me-2"></i>Pipeline Stage
                </h5>
                
                {% if pipeline_stages %}
                <div class="pipeline-slider">
                    <div class="pipeline-track">
                        {% for stage in pipeline_stages %}
                        <div class="pipeline-stage {% if current_stage and stage.id == current_stage.id %}active{% endif %}" 
                             data-stage-id="{{ stage.id }}" 
                             data-stage-name="{{ stage.name }}"
                             title="Click to move to {{ stage.name }}">
                            <div class="stage-circle">
                                <span class="stage-number">{{ forloop.counter }}</span>
                            </div>
                            <div class="stage-label">{{ stage.name }}</div>
                        </div>
                        {% if not forloop.last %}
                        <div class="pipeline-connector"></div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    
                    <div class="pipeline-actions mt-3 text-center">
                        <small class="text-white-50">Click on a stage to update pipeline position</small>
                    </div>
                </div>
                {% else %}
                <div class="text-center">
                    <span class="badge bg-light text-dark fs-6">No Pipeline Configured</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Basic Information Card -->
        <div class="card info-card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user me-2 text-primary"></i>Basic Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="field-label">Full Name</div>
                            <div class="field-value">{{ person.name|default:"Not specified" }}</div>
                        </div>
                        <div class="field-row">
                            <div class="field-label">Title</div>
                            <div class="field-value">{{ person.title|default:"Not specified" }}</div>
                        </div>
                        <div class="field-row">
                            <div class="field-label">Preferred Name</div>
                            <div class="field-value">{{ person.preferred_name|default:"Not specified" }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="field-label">Birthday</div>
                            <div class="field-value">{{ person.birthday|date:"M d, Y"|default:"Not specified" }}</div>
                        </div>
                        <div class="field-row">
                            <div class="field-label">Home Country</div>
                            <div class="field-value">{{ person.home_country|default:"Not specified" }}</div>
                        </div>
                        <div class="field-row">
                            <div class="field-label">Languages</div>
                            <div class="field-value">
                                {% if person.languages %}
                                    {% for lang in person.languages %}
                                        <span class="badge bg-light text-dark me-1">{{ lang }}</span>
                                    {% endfor %}
                                {% else %}
                                    Not specified
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information Card -->
        <div class="card contact-card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-address-card me-2 text-success"></i>Contact Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="field-label">Email</div>
                            <div class="field-value">
                                {% if person.contact.email %}
                                    <a href="#" onclick="openEmailCompose('{{ person.contact.email|escapejs }}', '{{ person.name|escapejs }}', {{ person.contact.id }})" class="text-decoration-none">
                                        <i class="fas fa-envelope me-1"></i>{{ person.contact.email }}
                                    </a>
                                {% else %}
                                    Not specified
                                {% endif %}
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="field-label">Phone</div>
                            <div class="field-value">
                                {% if person.contact.phone %}
                                    <div class="d-flex align-items-center gap-2">
                                        <a href="#" onclick="handlePhoneClick('{{ person.contact.phone }}', {{ person.pk }})" class="text-decoration-none">
                                            <i class="fas fa-phone me-1"></i>{{ person.contact.phone }}
                                        </a>
                                        <a href="#" onclick="handleSMSClick('{{ person.contact.phone }}', {{ person.pk }})" class="text-decoration-none text-success me-2" title="Send SMS">
                                            <i class="fas fa-sms"></i>
                                        </a>
                                        <a href="#" onclick="logReceivedSMS()" class="text-decoration-none text-info" title="Log Received SMS">
                                            <i class="fas fa-inbox"></i>
                                        </a>
                                    </div>
                                {% else %}
                                    Not specified
                                {% endif %}
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="field-label">Preferred Contact Method</div>
                            <div class="field-value">{{ person.contact.preferred_contact_method|default:"Not specified" }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="field-label">Address</div>
                            <div class="field-value">
                                {% if person.contact.full_address %}
                                    <address class="mb-0">
                                        {% if person.contact.street_address %}{{ person.contact.street_address }}<br>{% endif %}
                                        {% if person.contact.city or person.contact.state or person.contact.zip_code %}
                                            {{ person.contact.city }}{% if person.contact.city and person.contact.state %}, {% endif %}
                                            {{ person.contact.state }} {{ person.contact.zip_code }}<br>
                                        {% endif %}
                                        {% if person.contact.country and person.contact.country != 'United States' %}{{ person.contact.country }}{% endif %}
                                    </address>
                                    <a href="https://maps.google.com/?q={{ person.contact.full_address|urlencode }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                                        <i class="fas fa-map-marker-alt"></i> View on Map
                                    </a>
                                {% else %}
                                    Not specified
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Details Card -->
        <div class="card personal-card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-heart me-2 text-purple"></i>Personal Details
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="field-label">Marital Status</div>
                            <div class="field-value">{{ person.get_marital_status_display|default:"Not specified" }}</div>
                        </div>
                        {% if person.marital_status == 'married' %}
                        <div class="field-row">
                            <div class="field-label">Spouse</div>
                            <div class="field-value">{{ person.spouse_first_name }} {{ person.spouse_last_name|default:"" }}</div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="field-label">Anniversary</div>
                            <div class="field-value">{{ person.anniversary|date:"M d, Y"|default:"Not specified" }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Related Tasks -->
        <div class="card activity-card mb-4" style="border-left: 4px solid #17a2b8;">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tasks me-2 text-info"></i>Related Tasks
                </h5>
                <a href="/tasks/?person_id={{ person.pk }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-list"></i> View All
                </a>
            </div>
            <div class="card-body">
                {% if related_tasks %}
                    <div class="list-group">
                        {% for task in related_tasks %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ task.title|default:"Untitled Task" }}</h6>
                                        {% if task.description %}
                                            <p class="mb-1">{{ task.description|truncatechars:100 }}</p>
                                        {% endif %}
                                        <div class="d-flex align-items-center gap-2 mt-2">
                                            {% if task.status == 'completed' %}
                                                <span class="badge bg-success">{{ task.get_status_display }}</span>
                                            {% elif task.status == 'in_progress' %}
                                                <span class="badge bg-warning text-dark">{{ task.get_status_display }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ task.get_status_display }}</span>
                                            {% endif %}
                                            
                                            {% if task.priority == 'high' %}
                                                <span class="badge bg-danger">{{ task.get_priority_display }}</span>
                                            {% elif task.priority == 'medium' %}
                                                <span class="badge bg-warning text-dark">{{ task.get_priority_display }}</span>
                                            {% elif task.priority == 'low' %}
                                                <span class="badge bg-success">{{ task.get_priority_display }}</span>
                                            {% endif %}
                                            
                                            {% if task.category %}
                                                <span class="badge bg-light text-dark">{{ task.category }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        {% if task.due_date %}
                                            <small class="text-muted d-block">Due: {{ task.due_date|date:"M d, Y" }}</small>
                                        {% endif %}
                                        {% if task.due_time %}
                                            <small class="text-muted d-block">{{ task.due_time }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-tasks fa-3x mb-3"></i>
                        <p>No tasks assigned to this person yet.</p>
                        <a href="/tasks/create/?person_id={{ person.pk }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create First Task
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Communications -->
        <div class="card activity-card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-comments me-2 text-info"></i>Recent Communications
                </h5>
                <a href="/communications/?contact_id={{ person.contact.id }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-list"></i> View All
                </a>
            </div>
            <div class="card-body">
                {% if recent_communications %}
                    <div class="list-group">
                        {% for communication in recent_communications %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ communication.subject|default:"No Subject" }}</h6>
                                    <small class="text-muted">{{ communication.date|date:"M d, Y" }}</small>
                                </div>
                                <p class="mb-1">{{ communication.message|truncatechars:150|default:"No message content" }}</p>
                                <small class="text-muted">
                                    <span class="badge bg-secondary">{{ communication.type|default:"Communication" }}</span>
                                    {% if communication.sender %}
                                        by {{ communication.sender }}
                                    {% endif %}
                                </small>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-comment-slash fa-3x mb-3"></i>
                        <p>No communications recorded yet.</p>
                        <div class="d-flex gap-2 justify-content-center">
                            <a href="{% url 'communications:gmail_compose' %}?recipient={{ person.contact.email }}&name={{ person.name }}&contact_id={{ person.contact.id }}" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Email
                            </a>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-plus-circle"></i> Log Communication
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="openLogModal('phone', '{{ person.pk }}', '{{ person.name }}')">
                                        <i class="fas fa-phone me-2"></i>Phone Call
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="openLogModal('text', '{{ person.pk }}', '{{ person.name }}')">
                                        <i class="fas fa-sms me-2"></i>Text Message (Sent)
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="logReceivedSMS()">
                                        <i class="fas fa-inbox me-2"></i>Text Message (Received)
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="openLogModal('meeting', '{{ person.pk }}', '{{ person.name }}')">
                                        <i class="fas fa-users me-2"></i>Meeting
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="openLogModal('video_call', '{{ person.pk }}', '{{ person.name }}')">
                                        <i class="fas fa-video me-2"></i>Video Call
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="openLogModal('other', '{{ person.pk }}', '{{ person.name }}')">
                                        <i class="fas fa-comment-dots me-2"></i>Other
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Statistics Card -->
        <div class="card stats-card mb-4">
            <div class="card-body text-center">
                <h5 class="card-title text-white mb-3">
                    <i class="fas fa-chart-bar me-2"></i>Quick Stats
                </h5>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h3 text-white mb-0">{{ related_tasks|length }}</div>
                        <small class="text-white-50">Related Tasks</small>
                    </div>
                    <div class="col-6">
                        <div class="h3 text-white mb-0">{{ recent_communications|length }}</div>
                        <small class="text-white-50">Communications</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Card -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-flag me-2"></i>Status & Assignment
                </h5>
            </div>
            <div class="card-body">
                <div class="field-row">
                    <div class="field-label">Priority</div>
                    <div class="field-value">
                        {% if person.contact.priority == 'high' %}
                            <span class="badge bg-danger">High</span>
                        {% elif person.contact.priority == 'medium' %}
                            <span class="badge bg-warning text-dark">Medium</span>
                        {% elif person.contact.priority == 'low' %}
                            <span class="badge bg-success">Low</span>
                        {% else %}
                            <span class="text-muted">Not set</span>
                        {% endif %}
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-label">Status</div>
                    <div class="field-value">
                        {% if person.contact.status == 'active' %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ person.contact.get_status_display }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-label">Assigned To</div>
                    <div class="field-value">
                        {% if person.contact.user %}
                            {{ person.contact.user.full_name|default:person.contact.user.username }}
                        {% else %}
                            <span class="text-muted">Not assigned</span>
                        {% endif %}
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-label">Office</div>
                    <div class="field-value">
                        {% if person.contact.office %}
                            {{ person.contact.office.name }}
                        {% else %}
                            <span class="text-muted">Not assigned</span>
                        {% endif %}
                    </div>
                </div>
                {% if person.contact.last_contact_date or person.contact.next_contact_date %}
                <div class="field-row">
                    <div class="field-label">Last Contact</div>
                    <div class="field-value">{{ person.contact.last_contact_date|date:"M d, Y"|default:"Never" }}</div>
                </div>
                <div class="field-row">
                    <div class="field-label">Next Contact</div>
                    <div class="field-value">{{ person.contact.next_contact_date|date:"M d, Y"|default:"Not scheduled" }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Mission & Service Information Card -->
        {% if person.info_given or person.desired_service %}
        <div class="card mb-4" style="border-left: 4px solid #28a745;">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-globe me-2 text-success"></i>Mission & Service Information
                </h5>
            </div>
            <div class="card-body">
                {% if person.info_given %}
                <div class="field-row">
                    <div class="field-label">Information Given</div>
                    <div class="field-value">{{ person.info_given|linebreaks }}</div>
                </div>
                {% endif %}
                {% if person.desired_service %}
                <div class="field-row">
                    <div class="field-label">Desired Service</div>
                    <div class="field-value">{{ person.desired_service|linebreaks }}</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Professional Information Card -->
        <div class="card professional-card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-briefcase me-2 text-warning"></i>Professional Information
                </h5>
            </div>
            <div class="card-body">
                <div class="field-row">
                    <div class="field-label">Profession</div>
                    <div class="field-value">{{ person.profession|default:"Not specified" }}</div>
                </div>
                <div class="field-row">
                    <div class="field-label">Organization</div>
                    <div class="field-value">{{ person.organization|default:"Not specified" }}</div>
                </div>
            </div>
        </div>

        <!-- Church Relationship Card -->
        <div class="card church-card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-church me-2 text-danger"></i>Church Relationships
                </h5>
            </div>
            <div class="card-body">
                {% if person.church_memberships.all %}
                    <div class="list-group list-group-flush">
                        {% for membership in person.church_memberships.all %}
                            <div class="list-group-item px-0 py-2">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <h6 class="mb-0">
                                                <a href="{% url 'churches:church_detail' membership.church.pk %}" class="text-decoration-none">
                                                    {{ membership.church.name }}
                                                </a>
                                            </h6>
                                            {% if membership.is_primary_contact %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-star me-1"></i>Primary Contact
                                                </span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-2">
                                            <span class="badge bg-secondary">{{ membership.get_role_display }}</span>
                                            {% if membership.status != 'active' %}
                                                <span class="badge bg-warning text-dark">{{ membership.get_status_display }}</span>
                                            {% endif %}
                                        </div>
                                        
                                        {% if membership.start_date %}
                                        <div class="small text-muted">
                                            <i class="fas fa-calendar me-1"></i>Since {{ membership.start_date|date:"M Y" }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if membership.notes %}
                                <div class="mt-2 p-2 bg-light rounded small">
                                    <strong>Notes:</strong> {{ membership.notes }}
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-church fa-3x mb-3"></i>
                        <p>No church relationships recorded yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Social Media Card -->
        {% if person.linkedin_url or person.facebook_url or person.twitter_url or person.instagram_url %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-share-alt me-2"></i>Social Media
                </h5>
            </div>
            <div class="card-body">
                {% if person.linkedin_url %}
                <div class="social-link">
                    <a href="{{ person.linkedin_url }}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fab fa-linkedin me-2"></i>LinkedIn
                    </a>
                </div>
                {% endif %}
                {% if person.facebook_url %}
                <div class="social-link">
                    <a href="{{ person.facebook_url }}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fab fa-facebook me-2"></i>Facebook
                    </a>
                </div>
                {% endif %}
                {% if person.twitter_url %}
                <div class="social-link">
                    <a href="{{ person.twitter_url }}" target="_blank" class="btn btn-sm btn-outline-info w-100">
                        <i class="fab fa-twitter me-2"></i>Twitter
                    </a>
                </div>
                {% endif %}
                {% if person.instagram_url %}
                <div class="social-link">
                    <a href="{{ person.instagram_url }}" target="_blank" class="btn btn-sm btn-outline-warning w-100">
                        <i class="fab fa-instagram me-2"></i>Instagram
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Tags Card -->
        {% if person.contact.tags %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tags me-2"></i>Tags
                </h5>
            </div>
            <div class="card-body">
                {% for tag in person.contact.tags %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ tag }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Initial Notes Card -->
        {% if person.contact.initial_notes %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clipboard me-2"></i>Initial Notes
                    <small class="text-muted ms-2">(First Contact)</small>
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ person.contact.initial_notes|linebreaks }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Notes Card -->
        {% if person.contact.notes %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sticky-note me-2"></i>Notes
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ person.contact.notes|linebreaks }}</p>
            </div>
        </div>
        {% endif %}
        
        <!-- Metadata Card -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info me-2"></i>Metadata
                </h5>
            </div>
            <div class="card-body">
                <div class="field-row">
                    <div class="field-label">Created</div>
                    <div class="field-value">{{ person.contact.created_at|date:"M d, Y" }}</div>
                </div>
                <div class="field-row">
                    <div class="field-label">Last Updated</div>
                    <div class="field-value">{{ person.contact.updated_at|date:"M d, Y" }}</div>
                </div>
                <div class="field-row">
                    <div class="field-label">Created By</div>
                    <div class="field-value">
                        {% if person.contact.user %}
                            {{ person.contact.user.full_name|default:person.contact.user.username }}
                        {% else %}
                            <span class="text-muted">Unknown</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle email click - open Gmail compose in app
function openEmailCompose(email, name, contactId) {
    const composeUrl = `/communications/gmail/compose/?recipient=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}&contact_id=${contactId}`;
    window.location.href = composeUrl;
}

// Handle phone click - detect mobile and either dial or open communication log
function handlePhoneClick(phoneNumber, contactId) {
    const mobile = isMobileDevice();
    
    debugPhoneIntegration('Phone click detected', { 
        phoneNumber, 
        contactId, 
        isMobile: mobile,
        userAgent: navigator.userAgent
    });
    
    if (mobile) {
        // Clean up any old pending calls first
        cleanupOldPendingCommunications();
        
        // Store call information for when user returns from phone app
        const callInfo = {
            phoneNumber: phoneNumber,
            contactId: contactId,
            contactName: '{{ person.name|escapejs }}',
            timestamp: new Date().toISOString(),
            personDetailUrl: window.location.pathname, // Use pathname instead of full href to avoid query param issues
            sessionId: generateSessionId() // Add unique session ID to prevent conflicts
        };
        localStorage.setItem('pendingPhoneCall', JSON.stringify(callInfo));
        
        debugPhoneIntegration('Stored pending phone call', callInfo);
        
        // Track that we initiated a call to prevent false triggers
        window.phoneCallInitiated = true;
        setTimeout(() => { window.phoneCallInitiated = false; }, 2000);
        
        // Initiate the phone call
        debugPhoneIntegration('Initiating phone call', { tel: `tel:${phoneNumber}` });
        window.location.href = `tel:${phoneNumber}`;
    } else {
        // For desktop, directly open communication modal
        debugPhoneIntegration('Desktop detected, opening modal directly');
        openLogModal('phone', {{ person.pk }}, '{{ person.name|escapejs }}');
    }
}

// Handle SMS click - open SMS composition modal
function handleSMSClick(phoneNumber, contactId) {
    const mobile = isMobileDevice();
    
    debugPhoneIntegration('SMS click detected', { 
        phoneNumber, 
        contactId, 
        isMobile: mobile,
        userAgent: navigator.userAgent
    });
    
    // Always show SMS composition modal first
    openSMSCompositionModal(phoneNumber, contactId);
}

// Open SMS composition modal
function openSMSCompositionModal(phoneNumber, contactId) {
    // Create modal if it doesn't exist
    if (!document.getElementById('smsCompositionModal')) {
        createSMSCompositionModal();
    }
    
    const modal = new bootstrap.Modal(document.getElementById('smsCompositionModal'));
    const phoneInput = document.getElementById('smsPhoneNumber');
    const messageInput = document.getElementById('smsMessage');
    const contactIdInput = document.getElementById('smsContactId');
    
    // Pre-populate form
    phoneInput.value = phoneNumber;
    contactIdInput.value = contactId;
    messageInput.value = '';
    messageInput.focus();
    
    // Show the modal
    modal.show();
}

// Pipeline stage update functionality
document.addEventListener('DOMContentLoaded', function() {
    const pipelineStages = document.querySelectorAll('.pipeline-stage');
    
    pipelineStages.forEach(stage => {
        stage.addEventListener('click', function() {
            const stageId = this.dataset.stageId;
            const stageName = this.dataset.stageName;
            const contactId = {{ person.contact.id }};
            
            // Show loading state
            this.style.opacity = '0.6';
            this.style.pointerEvents = 'none';
            
            // Make AJAX request to update pipeline stage
            fetch('{% url "pipeline:update_contact_pipeline_stage" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
                },
                body: JSON.stringify({
                    contact_id: contactId,
                    contact_type: 'person',
                    stage_id: stageId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the UI
                    pipelineStages.forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show success message
                    showMessage('success', data.message);
                } else {
                    showMessage('error', data.error || 'Failed to update pipeline stage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('error', 'An error occurred while updating the pipeline stage');
            })
            .finally(() => {
                // Reset loading state
                this.style.opacity = '';
                this.style.pointerEvents = '';
            });
        });
    });
});

// Improved phone call and SMS return detection using Page Visibility API
document.addEventListener('DOMContentLoaded', function() {
    // Check if we should open a communication modal on page load
    checkForPendingCommunications();
    
    let visibilityTimeout;
    let hasProcessedVisibilityChange = false;
    
    // Listen for when user returns to the page (after phone call or SMS)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && !hasProcessedVisibilityChange) {
            // Clear any existing timeout
            if (visibilityTimeout) {
                clearTimeout(visibilityTimeout);
            }
            
            // Set flag to prevent duplicate processing
            hasProcessedVisibilityChange = true;
            
            // User returned to the page, check for pending communications
            visibilityTimeout = setTimeout(function() {
                checkForPendingCommunications();
                hasProcessedVisibilityChange = false; // Reset flag after processing
            }, 1500); // Increased delay for better mobile browser compatibility
        }
    });
    
    // Also listen for focus events as a fallback, but only if visibilitychange didn't fire
    let focusTimeout;
    window.addEventListener('focus', function() {
        if (!hasProcessedVisibilityChange) {
            if (focusTimeout) {
                clearTimeout(focusTimeout);
            }
            
            focusTimeout = setTimeout(function() {
                checkForPendingCommunications();
            }, 1500);
        }
    });
    
    // Additional event listeners for mobile browsers
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            // Page was restored from cache
            setTimeout(function() {
                checkForPendingCommunications();
            }, 1000);
        }
    });
});

// Unified function to check for pending communications
function checkForPendingCommunications() {
    checkForPendingPhoneCall();
    checkForPendingSMSMessage();
}

// Check for pending phone call and open communication modal
function checkForPendingPhoneCall() {
    const pendingCall = localStorage.getItem('pendingPhoneCall');
    if (!pendingCall) return;
    
    try {
        const callInfo = JSON.parse(pendingCall);
        const now = new Date();
        const callTime = new Date(callInfo.timestamp);
        const timeDiff = now - callTime;
        
        // Only process if call was initiated within the last 2 minutes
        // and we're on the correct person's detail page (using pathname for reliability)
        if (timeDiff < 120000 && 
            window.location.pathname === callInfo.personDetailUrl &&
            callInfo.contactId == {{ person.pk }}) {
            
            // Clear the pending call immediately to prevent duplicates
            localStorage.removeItem('pendingPhoneCall');
            
            // Only open modal if we're not in the middle of another action
            if (!window.phoneCallInitiated && !document.querySelector('.modal.show')) {
                // Open the communication modal with phone call pre-selected
                setTimeout(function() {
                    openPhoneCallModal(callInfo.contactId, callInfo.contactName, callInfo.phoneNumber);
                }, 500); // Reduced delay for better responsiveness
            }
        } else if (timeDiff >= 120000) {
            // Clean up old pending calls (older than 2 minutes)
            localStorage.removeItem('pendingPhoneCall');
        }
    } catch (e) {
        // Clean up corrupted data
        localStorage.removeItem('pendingPhoneCall');
    }
}

// Open communication modal specifically for phone calls
function openPhoneCallModal(contactId, contactName, phoneNumber) {
    // Create modal if it doesn't exist
    if (!document.getElementById('logCommunicationModal')) {
        createCommunicationModal();
    }
    
    // Open the modal with phone call pre-selected
    openLogModal('phone', contactId, contactName);
    
    // Pre-fill the subject with the phone number
    setTimeout(function() {
        const subjectInput = document.getElementById('communicationSubject');
        if (subjectInput && phoneNumber) {
            subjectInput.value = `Phone call to ${phoneNumber}`;
        }
        
        // Set today's date
        const dateInput = document.getElementById('communicationDate');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
        
        // Focus on the notes field for user convenience
        const notesField = document.getElementById('communicationMessage');
        if (notesField) {
            notesField.focus();
            notesField.placeholder = 'Add notes about your phone conversation...';
        }
    }, 100);
}

// Check for pending SMS message and open communication modal
function checkForPendingSMSMessage() {
    const pendingSMS = localStorage.getItem('pendingSMSMessage');
    if (!pendingSMS) return;
    
    try {
        const smsInfo = JSON.parse(pendingSMS);
        const now = new Date();
        const smsTime = new Date(smsInfo.timestamp);
        const timeDiff = now - smsTime;
        
        // Only process if SMS was initiated within the last 2 minutes
        // and we're on the correct person's detail page (using pathname for reliability)
        if (timeDiff < 120000 && 
            window.location.pathname === smsInfo.personDetailUrl &&
            smsInfo.contactId == {{ person.pk }}) {
            
            // Clear the pending SMS immediately to prevent duplicates
            localStorage.removeItem('pendingSMSMessage');
            
            // Only open modal if we're not in the middle of another action
            if (!window.smsInitiated && !document.querySelector('.modal.show')) {
                // Open the communication modal with SMS pre-selected and message content
                setTimeout(function() {
                    openSMSModal(smsInfo.contactId, smsInfo.contactName, smsInfo.phoneNumber, smsInfo.messageContent);
                }, 500); // Reduced delay for better responsiveness
            }
        } else if (timeDiff >= 120000) {
            // Clean up old pending SMS (older than 2 minutes)
            localStorage.removeItem('pendingSMSMessage');
        }
    } catch (e) {
        // Clean up corrupted data
        localStorage.removeItem('pendingSMSMessage');
    }
}

// Open communication modal specifically for SMS messages
function openSMSModal(contactId, contactName, phoneNumber, messageContent) {
    // Create modal if it doesn't exist
    if (!document.getElementById('logCommunicationModal')) {
        createCommunicationModal();
    }
    
    // Open the modal with SMS pre-selected
    openLogModal('text', contactId, contactName);
    
    // Pre-fill the subject with the phone number and message content
    setTimeout(function() {
        const subjectInput = document.getElementById('communicationSubject');
        if (subjectInput && phoneNumber) {
            subjectInput.value = `SMS to ${phoneNumber}`;
        }
        
        // Set today's date
        const dateInput = document.getElementById('communicationDate');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
        
        // Pre-populate the message field with the sent message content
        const notesField = document.getElementById('communicationMessage');
        if (notesField) {
            if (messageContent) {
                notesField.value = `Message sent: "${messageContent}"\n\nAdditional notes:`;
                // Move cursor to end for additional notes
                notesField.setSelectionRange(notesField.value.length, notesField.value.length);
            }
            notesField.focus();
            notesField.placeholder = 'Add notes about your text message conversation...';
        }
    }, 100);
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Helper function to show messages
function showMessage(type, message) {
    // Create a toast-style message
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Communication logging functions
function openLogModal(type, contactId, contactName) {
    // Create modal if it doesn't exist
    if (!document.getElementById('logCommunicationModal')) {
        createCommunicationModal();
    }
    
    const modal = new bootstrap.Modal(document.getElementById('logCommunicationModal'));
    const typeInput = document.getElementById('communicationType');
    const modalTitle = document.getElementById('logCommunicationModalLabel');
    const videoCallOptions = document.getElementById('videoCallOptions');
    const personSelect = document.getElementById('personSelect');
    const subjectInput = document.getElementById('communicationSubject');
    
    // Map shorthand types to full Communication model values
    const typeMapping = {
        'phone': 'Phone Call',
        'text': 'Text Message',
        'meeting': 'Meeting',
        'video_call': 'Video Call',
        'other': 'Email'  // Default fallback
    };
    
    // Set the communication type
    typeInput.value = typeMapping[type] || type;
    
    // Update modal title based on type
    const typeLabels = {
        'phone': 'Log Phone Call',
        'text': 'Log Text Message', 
        'meeting': 'Log Meeting',
        'video_call': 'Log Video Call',
        'other': 'Log Other Communication'
    };
    modalTitle.textContent = typeLabels[type] || 'Log Communication';
    
    // Show/hide video call options
    if (type === 'video_call') {
        videoCallOptions.style.display = 'block';
    } else {
        videoCallOptions.style.display = 'none';
    }
    
    // Pre-populate contact selection
    if (contactId && personSelect) {
        // Add option if it doesn't exist
        let optionExists = false;
        for (let option of personSelect.options) {
            if (option.value == contactId) {
                option.selected = true;
                optionExists = true;
                break;
            }
        }
        
        if (!optionExists) {
            const newOption = document.createElement('option');
            newOption.value = contactId;
            newOption.textContent = contactName;
            newOption.selected = true;
            personSelect.appendChild(newOption);
        }
    }
    
    // Pre-populate subject based on type and contact
    if (subjectInput) {
        const subjectPrefixes = {
            'phone': 'Phone call with',
            'text': 'Text message with',
            'meeting': 'Meeting with',
            'video_call': 'Video call with',
            'other': 'Communication with'
        };
        subjectInput.value = `${subjectPrefixes[type] || 'Communication with'} ${contactName}`;
    }
    
    // Set today's date as default
    const dateInput = document.getElementById('communicationDate');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Show the modal
    modal.show();
}

function createCommunicationModal() {
    const modalHTML = `
<!-- Log Communication Modal -->
<div class="modal fade" id="logCommunicationModal" tabindex="-1" aria-labelledby="logCommunicationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logCommunicationModalLabel">Log Communication</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="logCommunicationForm" method="post" action="{% url 'communications:communication_create' %}">
                {% csrf_token %}
                <input type="hidden" name="redirect_to" value="{% url 'contacts:person_detail' person.pk %}">
                <div class="modal-body">
                    <input type="hidden" id="communicationType" name="type" value="">
                    
                    <!-- Subject/Title -->
                    <div class="mb-3">
                        <label for="communicationSubject" class="form-label">Subject/Title</label>
                        <input type="text" class="form-control" id="communicationSubject" name="subject" required>
                    </div>
                    
                    <!-- Contact Selection -->
                    <div class="mb-3">
                        <label for="personSelect" class="form-label">Person</label>
                        <select class="form-select" id="personSelect" name="person" required>
                            <option value="">Select Person...</option>
                            <option value="{{ person.pk }}" selected>{{ person.name }}</option>
                        </select>
                    </div>
                    
                    <!-- Date -->
                    <div class="mb-3">
                        <label for="communicationDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="communicationDate" name="date" required>
                    </div>
                    
                    <!-- Direction -->
                    <div class="mb-3">
                        <label for="communicationDirection" class="form-label">Direction</label>
                        <select class="form-select" id="communicationDirection" name="direction" required>
                            <option value="outbound" selected>Outbound (I initiated)</option>
                            <option value="inbound">Inbound (They initiated)</option>
                        </select>
                    </div>
                    
                    <!-- Message/Notes -->
                    <div class="mb-3">
                        <label for="communicationMessage" class="form-label">Notes/Summary</label>
                        <textarea class="form-control" id="communicationMessage" name="message" rows="4" placeholder="Add notes about this communication..."></textarea>
                    </div>
                    
                    <!-- Video Call Options -->
                    <div id="videoCallOptions" style="display: none;">
                        <div class="mb-3">
                            <label for="meetLink" class="form-label">Meeting Link</label>
                            <input type="url" class="form-control" id="meetLink" name="google_meet_link" placeholder="https://meet.google.com/...">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Log Communication</button>
                </div>
            </form>
        </div>
    </div>
</div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Create SMS composition modal
function createSMSCompositionModal() {
    const modalHTML = `
<!-- SMS Composition Modal -->
<div class="modal fade" id="smsCompositionModal" tabindex="-1" aria-labelledby="smsCompositionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="smsCompositionModalLabel">
                    <i class="fas fa-sms me-2"></i>Send Text Message
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="smsCompositionForm">
                <div class="modal-body">
                    <input type="hidden" id="smsContactId" name="contact_id" value="">
                    <input type="hidden" name="contact_type" value="person">
                    
                    <!-- Phone Number -->
                    <div class="mb-3">
                        <label for="smsPhoneNumber" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="smsPhoneNumber" name="to_number" required readonly>
                    </div>
                    
                    <!-- Message -->
                    <div class="mb-3">
                        <label for="smsMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="smsMessage" name="message" rows="4" 
                                  placeholder="Enter your text message..." required maxlength="160"></textarea>
                        <div class="form-text">
                            <span id="smsCharCount">0</span>/160 characters
                        </div>
                    </div>
                    
                    <!-- Send Options -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="smsLogCommunication" checked>
                            <label class="form-check-label" for="smsLogCommunication">
                                Log this message in communications
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendViaNativeApp()">
                        <i class="fas fa-mobile-alt me-1"></i> Send via Phone
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add event listeners
    const form = document.getElementById('smsCompositionForm');
    const messageInput = document.getElementById('smsMessage');
    const charCount = document.getElementById('smsCharCount');
    
    // Character counter
    messageInput.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = count;
        
        // Change color based on character count
        if (count > 140) {
            charCount.style.color = '#dc3545'; // red
        } else if (count > 120) {
            charCount.style.color = '#fd7e14'; // orange
        } else {
            charCount.style.color = '#28a745'; // green
        }
    });
    
    // Form submission (not needed for native app, but kept for structure)
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        sendViaNativeApp();
    });
}

// Send SMS via native app (fallback)
function sendViaNativeApp() {
    const phoneNumber = document.getElementById('smsPhoneNumber').value;
    const message = document.getElementById('smsMessage').value;
    const contactId = document.getElementById('smsContactId').value;
    
    // Store SMS info for when user returns to app
    const smsInfo = {
        contactId: contactId,
        contactName: '{{ person.name|escapejs }}',
        phoneNumber: phoneNumber,
        messageContent: message, // Store the actual message content
        timestamp: new Date().toISOString(),
        personDetailUrl: window.location.pathname
    };
    localStorage.setItem('pendingSMSMessage', JSON.stringify(smsInfo));
    
    // Create SMS URL with pre-filled message - improved cross-platform compatibility
    let smsUrl;
    
    // Clean the phone number (remove any non-digit characters except +)
    const cleanPhoneNumber = phoneNumber.replace(/[^\d+]/g, '');
    
    if (message && message.trim()) {
        // Encode the message for URL
        const encodedMessage = encodeURIComponent(message.trim());
        
        // Different URL formats for different platforms
        const userAgent = navigator.userAgent.toLowerCase();
        
        if (userAgent.includes('android')) {
            // Android format: sms:number?body=message
            smsUrl = `sms:${cleanPhoneNumber}?body=${encodedMessage}`;
        } else if (userAgent.includes('iphone') || userAgent.includes('ipad') || userAgent.includes('ipod')) {
            // iOS format: sms:number?body=message (standard format)
            // Some iOS versions may need & instead of ? - we'll try both if needed
            smsUrl = `sms:${cleanPhoneNumber}?body=${encodedMessage}`;
        } else {
            // Generic/fallback format
            smsUrl = `sms:${cleanPhoneNumber}?body=${encodedMessage}`;
        }
    } else {
        // No message, just the phone number
        smsUrl = `sms:${cleanPhoneNumber}`;
    }
    
    debugPhoneIntegration('SMS URL created', { 
        originalPhone: phoneNumber, 
        cleanPhone: cleanPhoneNumber, 
        message: message, 
        smsUrl: smsUrl,
        userAgent: navigator.userAgent
    });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('smsCompositionModal'));
    modal.hide();
    
    // Try the primary SMS URL first
    try {
        window.location.href = smsUrl;
    } catch (error) {
        // If primary format fails, try alternative format
        debugPhoneIntegration('Primary SMS URL failed, trying alternative', { error: error.message });
        
        if (message && message.trim()) {
            const encodedMessage = encodeURIComponent(message.trim());
            // Try the opposite format as fallback
            const alternativeUrl = smsUrl.includes('?body=') ? 
                `sms:${cleanPhoneNumber}&body=${encodedMessage}` : 
                `sms:${cleanPhoneNumber}?body=${encodedMessage}`;
            
            debugPhoneIntegration('Trying alternative SMS URL', { alternativeUrl });
            window.location.href = alternativeUrl;
        } else {
            window.location.href = `sms:${cleanPhoneNumber}`;
        }
    }
}

// Note: Server-side SMS sending removed to keep solution free and use native phone app only
// For incoming SMS logging, users will need to manually log received messages using the communication modal

// Helper function to open communication modal for manual SMS logging
function logReceivedSMS() {
    openLogModal('text', {{ person.pk }}, '{{ person.name|escapejs }}');
    
    // Pre-fill for received message
    setTimeout(function() {
        const subjectInput = document.getElementById('communicationSubject');
        if (subjectInput) {
            subjectInput.value = 'SMS received from {{ person.name|escapejs }}';
        }
        
        const directionSelect = document.getElementById('communicationDirection');
        if (directionSelect) {
            directionSelect.value = 'inbound';
        }
        
        const notesField = document.getElementById('communicationMessage');
        if (notesField) {
            notesField.placeholder = 'Enter the message you received and any additional notes...';
            notesField.focus();
        }
    }, 100);
}

// Utility functions for improved phone integration

// Generate a unique session ID to prevent conflicts
function generateSessionId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// Clean up old pending communications to prevent memory buildup
function cleanupOldPendingCommunications() {
    const now = new Date();
    const maxAge = 120000; // 2 minutes
    
    // Clean up old phone calls
    const pendingCall = localStorage.getItem('pendingPhoneCall');
    if (pendingCall) {
        try {
            const callInfo = JSON.parse(pendingCall);
            const callTime = new Date(callInfo.timestamp);
            if (now - callTime > maxAge) {
                localStorage.removeItem('pendingPhoneCall');
            }
        } catch (e) {
            localStorage.removeItem('pendingPhoneCall');
        }
    }
    
    // Clean up old SMS messages
    const pendingSMS = localStorage.getItem('pendingSMSMessage');
    if (pendingSMS) {
        try {
            const smsInfo = JSON.parse(pendingSMS);
            const smsTime = new Date(smsInfo.timestamp);
            if (now - smsTime > maxAge) {
                localStorage.removeItem('pendingSMSMessage');
            }
        } catch (e) {
            localStorage.removeItem('pendingSMSMessage');
        }
    }
}

// Enhanced mobile detection with more comprehensive user agent checking
function isMobileDevice() {
    const userAgent = navigator.userAgent.toLowerCase();
    const mobileKeywords = [
        'android', 'iphone', 'ipad', 'ipod', 'blackberry', 'windows phone',
        'webos', 'opera mini', 'iemobile', 'mobile', 'tablet'
    ];
    
    // Check user agent
    const isMobileUA = mobileKeywords.some(keyword => userAgent.includes(keyword));
    
    // Check for touch capability
    const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    
    // Check screen size (mobile-like dimensions)
    const isSmallScreen = window.innerWidth <= 768 || window.innerHeight <= 600;
    
    return isMobileUA || (hasTouch && isSmallScreen);
}

// Debug function to log phone integration events (can be enabled for troubleshooting)
function debugPhoneIntegration(message, data = {}) {
    if (window.phoneIntegrationDebug) {
        console.log(`[Phone Integration] ${message}`, data);
    }
}

// Enable debug mode by default for SMS troubleshooting
// To disable, run: window.phoneIntegrationDebug = false; in console
window.phoneIntegrationDebug = true;
</script>
{% endblock %}