{% extends 'base.html' %}
{% load static %}

{% block title %}People - Mobilize CRM{% endblock %}

{% block page_title %}People{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <a href="{% url 'contacts:person_create' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add Person
    </a>
    <a href="{% url 'contacts:google_sync' %}" class="btn btn-success">
        <i class="fab fa-google"></i> Add from Google Workspace
    </a>
    <a href="{% url 'contacts:import_contacts' %}" class="btn btn-secondary">
        <i class="fas fa-upload"></i> Import
    </a>
    <a href="{% url 'contacts:export_contacts' %}" class="btn btn-outline-secondary">
        <i class="fas fa-download"></i> Export
    </a>
</div>
{% endblock %}

{% block content %}
<!-- View Mode Toggle for Admins -->
{% if can_toggle_view %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="d-flex align-items-center gap-2 flex-nowrap" style="overflow-x: auto;">
                    <div class="d-flex align-items-center gap-2" style="flex-shrink: 0;">
                        <i class="fas fa-eye text-muted"></i>
                        <span class="text-muted">View Mode:</span>
                    </div>
                    
                    {% if user_role == 'super_admin' %}
                        <!-- Toggle Buttons for Super Admin -->
                        <div class="btn-group" role="group" aria-label="View mode toggle" style="flex-shrink: 0;">
                            <a href="?view_mode=default{% if query %}&q={{ query }}{% endif %}{% if priority %}&priority={{ priority }}{% endif %}{% if pipeline_stage %}&pipeline_stage={{ pipeline_stage }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
                               class="btn btn-sm {% if current_view_mode == 'default' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-globe me-1"></i> All Offices
                            </a>
                            <a href="?view_mode=my_only{% if query %}&q={{ query }}{% endif %}{% if priority %}&priority={{ priority }}{% endif %}{% if pipeline_stage %}&pipeline_stage={{ pipeline_stage }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
                               class="btn btn-sm {% if current_view_mode == 'my_only' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-user me-1"></i> My Contacts Only
                            </a>
                        </div>
                        <!-- Office Selector Dropdown -->
                        <select id="office-selector" class="form-select form-select-sm" style="width: 140px; flex-shrink: 0;">
                            <option value="default" {% if current_view_mode == "default" %}selected{% endif %}>All Offices</option>
                            <option value="" disabled>-------------------</option>
                            <option value="office_unassigned" 
                                {% if current_view_mode == 'office_unassigned' %}selected{% endif %}>
                                Unassigned (No Office)
                            </option>
                            <option value="" disabled>-------------------</option>
                            {% for office in all_offices %}
                            <option value="office_{{ office.id }}" 
                                {% if current_view_mode == 'office_'|add:office.id|stringformat:"s" %}selected{% endif %}>
                                {{ office.name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <!-- Toggle Buttons for Office Admin -->
                        <div class="btn-group" role="group" aria-label="View mode toggle" style="flex-shrink: 0;">
                            <a href="?view_mode=default{% if query %}&q={{ query }}{% endif %}{% if priority %}&priority={{ priority }}{% endif %}{% if pipeline_stage %}&pipeline_stage={{ pipeline_stage }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
                               class="btn btn-sm {% if current_view_mode == 'default' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-building me-1"></i> My Office
                            </a>
                            <a href="?view_mode=my_only{% if query %}&q={{ query }}{% endif %}{% if priority %}&priority={{ priority }}{% endif %}{% if pipeline_stage %}&pipeline_stage={{ pipeline_stage }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
                               class="btn btn-sm {% if current_view_mode == 'my_only' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-user me-1"></i> My Contacts Only
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Bulk Operations Bar - LAZY TEMPLATE FIXED -->
<div class="card mb-3" id="bulk-operations" style="display: none;">
    <div class="card-body py-2">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <span class="text-muted"><span id="selected-count">0</span> selected</span>
            
            <!-- Bulk Delete -->
            <form method="post" action="{% url 'contacts:bulk_delete' %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete the selected contacts?');">
                {% csrf_token %}
                <input type="hidden" name="contact_ids" id="bulk-delete-ids">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </form>
            
            <!-- Bulk Priority Update -->
            <form method="post" action="{% url 'contacts:bulk_update_priority' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="contact_ids" id="bulk-priority-ids">
                <select name="priority" class="form-select form-select-sm" style="width: auto; display: inline;">
                    <option value="">Change Priority...</option>
                    {% for priority_value, priority_label in priorities %}
                    <option value="{{ priority_value }}">{{ priority_label }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Update</button>
            </form>
            
            <!-- Bulk User Assignment -->
            <form method="post" action="{% url 'contacts:bulk_assign_user' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="contact_ids" id="bulk-user-ids">
                <select name="user_id" class="form-select form-select-sm" style="width: auto; display: inline;">
                    <option value="">Assign to User...</option>
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.get_full_name|default:user.email }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Assign</button>
            </form>
            
            <!-- Bulk Office Assignment -->
            <form method="post" action="{% url 'contacts:bulk_assign_office' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="contact_ids" id="bulk-office-ids">
                <select name="office_id" class="form-select form-select-sm" style="width: auto; display: inline;">
                    <option value="">Assign to Office...</option>
                    {% for office in offices %}
                    <option value="{{ office.id }}">{{ office.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Assign</button>
            </form>
        </div>
    </div>
</div>

<!-- Search and Filter - UPDATED TO HORIZONTAL LAYOUT 2025-01-26 -->
<div class="card mb-3">
    <div class="card-body py-3">
        <form method="get">
            <!-- Mobile: stacked layout -->
            <div class="d-md-none">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="search-mobile" class="form-label">Search People</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control" id="search-mobile" name="q" 
                                   value="{{ query }}" placeholder="Search people...">
                        </div>
                    </div>
                    <div class="col-6">
                        <label for="priority-mobile" class="form-label">Filter by Priority</label>
                        <select class="form-select" id="priority-mobile" name="priority" onchange="this.form.submit()">
                            <option value="">All Priorities</option>
                            {% for priority_value, priority_label in priorities %}
                                <option value="{{ priority_value }}" {% if priority == priority_value %}selected{% endif %}>
                                    {{ priority_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6">
                        <label for="pipeline-mobile" class="form-label">Filter by Pipeline Stage</label>
                        <select class="form-select" id="pipeline-mobile" name="pipeline_stage" onchange="this.form.submit()">
                            <option value="">All Pipeline Stages</option>
                            {% for stage_value, stage_label in pipeline_stages %}
                                <option value="{{ stage_value }}" {% if pipeline_stage == stage_value %}selected{% endif %}>
                                    {{ stage_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                            <a href="{% url 'contacts:person_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Clear
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Desktop: single line layout -->
            <div class="d-none d-md-flex align-items-center gap-2 flex-nowrap">
                <div class="input-group" style="min-width: 250px; flex: 1;">
                    <span class="input-group-text bg-light">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" name="q" class="form-control" placeholder="Search people..." 
                           value="{{ query }}">
                </div>
                <select name="priority" class="form-select" style="min-width: 140px; width: auto;" onchange="this.form.submit()">
                    <option value="">All Priorities</option>
                    {% for priority_value, priority_label in priorities %}
                        <option value="{{ priority_value }}" {% if priority == priority_value %}selected{% endif %}>
                            {{ priority_label }}
                        </option>
                    {% endfor %}
                </select>
                <select name="pipeline_stage" class="form-select" style="min-width: 160px; width: auto;" onchange="this.form.submit()">
                    <option value="">All Pipeline Stages</option>
                    {% for stage_value, stage_label in pipeline_stages %}
                        <option value="{{ stage_value }}" {% if pipeline_stage == stage_value %}selected{% endif %}>
                            {{ stage_label }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary px-3">
                    <i class="fas fa-search"></i>
                </button>
                <a href="{% url 'contacts:person_list' %}" class="btn btn-outline-secondary px-3">
                    <i class="fas fa-times"></i>
                </a>
            </div>
            
            <!-- Keep query and filters when changing the view mode or pagination -->
            {% if current_view_mode %}
                <input type="hidden" name="view_mode" value="{{ current_view_mode }}">
            {% endif %}
        </form>
    </div>
</div>

<!-- Legacy dynamic search functionality maintained for backward compatibility -->
<div style="display: none;">
    <input type="text" id="main-search-input" value="{{ query }}">
    <select id="quick-priority-filter">
        <option value="">All Priorities</option>
        {% for priority_value, priority_label in priorities %}
        <option value="{{ priority_value }}" {% if priority == priority_value %}selected{% endif %}>{{ priority_label }}</option>
        {% endfor %}
    </select>
    <select id="quick-pipeline-filter" style="display: none;">
        <option value="">All Stages</option>
        {% for stage_value, stage_label in pipeline_stages %}
        <option value="{{ stage_value }}" {% if pipeline_stage == stage_value %}selected{% endif %}>{{ stage_label }}</option>
        {% endfor %}
    </select>
</div>

<div class="card">
    <div class="card-body">

        <!-- Data Table with Lazy Loading -->
        <div class="table-responsive">
            <table id="people-table" class="table table-hover" data-sortable-table>
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="select-all" class="form-check-input">
                        </th>
                        <th data-sortable="text">Name</th>
                        <th data-sortable="text">Email</th>
                        <th data-sortable="text">Phone</th>
                        <th data-sortable="priority">Priority</th>
                        <th data-sortable="badge">Pipeline Stage</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="person-table-body">
                    {% comment %}
                    Initial rows will be loaded by JavaScript using lazy loading
                    {% endcomment %}
                </tbody>
            </table>
        </div>
        
        <!-- No Results Message -->
        <div id="no-results" class="text-center text-muted py-4" style="display: none;">
            No people found. <a href="{% url 'contacts:person_create' %}">Add the first person</a>.
        </div>
        
        <!-- Pagination Status and Load More Button -->
        <div class="d-flex justify-content-between align-items-center mt-3" id="pagination-controls">
            <div class="text-muted">
                <span id="showing-text">Showing <span id="current-count">0</span> of <span id="total-count">0</span> people</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center gap-2">
                    <label for="per-page-select" class="form-label mb-0 text-muted">Show:</label>
                    <select id="per-page-select" class="form-select form-select-sm" style="width: auto;">
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" id="load-more-btn" style="display: none;">
                        Load More <span id="per-page-count">25</span>
                    </button>
                    <span class="text-muted" id="end-reached" style="display: none;">
                        <i class="fas fa-check-circle text-success"></i> All people loaded
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/lazy-loading.js' %}?v=1750793997"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize lazy loader for person list
    const personLoader = new LazyLoader({
        tableBody: document.getElementById('person-table-body'),
        apiUrl: '{% url "contacts:person_list_api" %}',
        perPage: 25,
        enableInfiniteScroll: false,  // Disable auto-scroll for manual pagination
        filters: {
            q: '{{ query }}',
            priority: '{{ priority }}',
            pipeline_stage: '{{ pipeline_stage }}',
            sort: '{{ sort_by }}'
        }
    });
    
    // Override the row template for person-specific rendering
    personLoader.getRowTemplate = function(item) {
        return `
            <td>
                <input type="checkbox" name="contact_ids" value="${item.id}" class="form-check-input contact-checkbox">
            </td>
            <td>
                <a href="${item.detail_url}">${item.name}</a>
            </td>
            <td>
                ${item.email ? 
                    `<a href="#" onclick="openEmailCompose('${item.email.replace(/'/g, '\\\'').replace(/"/g, '\\"')}', '${item.name.replace(/'/g, '\\\'').replace(/"/g, '\\"')}', ${item.id})" class="text-decoration-none">
                        <i class="fas fa-envelope me-1"></i>${item.email}
                    </a>` : '-'}
            </td>
            <td>
                ${item.phone ? 
                    `<a href="#" onclick="handlePhoneClick('${item.phone}', ${item.id}, '${item.name.replace(/'/g, "\\'")}'" class="text-decoration-none">
                        <i class="fas fa-phone me-1"></i>${item.phone}
                    </a>` : '-'}
            </td>
            <td>${this.getPriorityBadge(item.priority_display || item.priority)}</td>
            <td>${this.getPipelineBadge(item.pipeline_stage)}</td>
            <td>${this.getActionButtons(item)}</td>
        `;
    };
    
    // Set up pagination controls FIRST
    const loadMoreBtn = document.getElementById('load-more-btn');
    const currentCountSpan = document.getElementById('current-count');
    const totalCountSpan = document.getElementById('total-count');
    const endReachedSpan = document.getElementById('end-reached');
    const perPageSelect = document.getElementById('per-page-select');
    const perPageCount = document.getElementById('per-page-count');
    
    // Load more button click handler (only if infinite scroll is disabled)
    if (!personLoader.enableInfiniteScroll) {
        loadMoreBtn.addEventListener('click', () => {
            personLoader.loadMore();
        });
    }
    
    // Per-page selector change handler
    perPageSelect.addEventListener('change', (e) => {
        const newPerPage = parseInt(e.target.value);
        personLoader.perPage = newPerPage;
        perPageCount.textContent = newPerPage;
        personLoader.resetAndLoad();
    });
    
    // Override the loadMore to reinitialize sorting after content loads
    const originalLoadMore = personLoader.loadMore.bind(personLoader);
    personLoader.loadMore = async function() {
        console.log('DEBUG: loadMore called for people');
        try {
            const result = await originalLoadMore();
            console.log('DEBUG: loadMore completed successfully for people');
            // Reinitialize sorting after content loads
            if (window.reinitializeSortableTables) {
                window.reinitializeSortableTables();
            }
            return result;
        } catch (error) {
            console.error('DEBUG: loadMore failed for people:', error);
            throw error;
        }
    };
    
    // Load initial data AFTER pagination controls are set up
    personLoader.loadMore();
    
    // Listen for loader updates to get accurate total count
    window.addEventListener('lazyLoaderUpdate', (event) => {
        const { total, loaded, hasMore } = event.detail;
        // The LazyLoader now handles updating the counts directly
        // This listener is kept for any future custom logic if needed
    });
    
    // Bulk operations management - LAZY TEMPLATE DEBUG
    console.log('DEBUG: Lazy template DOM loaded - initializing bulk operations');
    const selectAll = document.getElementById('select-all');
    const bulkOpsBar = document.getElementById('bulk-operations');
    const selectedCount = document.getElementById('selected-count');
    
    console.log('DEBUG: Elements found:', {
        selectAll: !!selectAll,
        bulkOpsBar: !!bulkOpsBar,
        selectedCount: !!selectedCount
    });
    
    window.updateBulkOperations = function() {
        console.log('DEBUG: updateBulkOperations called - LAZY TEMPLATE FIXED VERSION');
        const checkboxes = document.querySelectorAll('.contact-checkbox');
        const selected = document.querySelectorAll('.contact-checkbox:checked');
        const count = selected.length;
        console.log('DEBUG: Selected checkboxes count:', count);
        
        selectedCount.textContent = count;
        
        // Use CSS class system like other pages instead of direct style manipulation
        if (bulkOpsBar) {
            if (count > 0) {
                bulkOpsBar.classList.add('show');
                console.log('DEBUG: Added show class to bulk operations');
            } else {
                bulkOpsBar.classList.remove('show');
                console.log('DEBUG: Removed show class from bulk operations');
            }
        }
        
        // Update hidden inputs for bulk operations
        const ids = Array.from(selected).map(cb => cb.value).join(',');
        document.getElementById('bulk-delete-ids').value = ids;
        document.getElementById('bulk-priority-ids').value = ids;
        document.getElementById('bulk-user-ids').value = ids;
        document.getElementById('bulk-office-ids').value = ids;
        
        // Update select all checkbox state
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        const noneChecked = Array.from(checkboxes).every(cb => !cb.checked);
        
        selectAll.checked = allChecked;
        selectAll.indeterminate = !allChecked && !noneChecked;
    };
    
    // Select all functionality
    selectAll.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.contact-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBulkOperations();
    });
    
    // Individual checkbox functionality - CRITICAL FIX
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('contact-checkbox')) {
            console.log('DEBUG: Individual checkbox changed');
            updateBulkOperations();
        }
    });
    
    // Handle bulk operation form submissions
    document.querySelectorAll('form select[name="priority"]').forEach(select => {
        select.addEventListener('change', function() {
            if (this.value) {
                this.closest('form').submit();
            }
        });
    });
    
    document.querySelectorAll('form select[name="user_id"]').forEach(select => {
        select.addEventListener('change', function() {
            if (this.value) {
                this.closest('form').submit();
            }
        });
    });
    
    document.querySelectorAll('form select[name="office_id"]').forEach(select => {
        select.addEventListener('change', function() {
            if (this.value) {
                this.closest('form').submit();
            }
        });
    });
    
    function updateFilters() {
        personLoader.updateFilters({
            q: mainSearchInput ? mainSearchInput.value : '',
            priority: quickPriorityFilter ? quickPriorityFilter.value : '',
            pipeline_stage: quickPipelineFilter ? quickPipelineFilter.value : '',
            sort: ''
        });
        // Reset and reload data with new filters
        personLoader.resetAndLoad();
    }
    
    // Add event listeners for search input and quick filters
    const mainSearchInput = document.getElementById('main-search-input');
    const quickPriorityFilter = document.getElementById('quick-priority-filter');
    const quickPipelineFilter = document.getElementById('quick-pipeline-filter');
    
    // Debounce function for dynamic search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Add event listeners to main search input
    if (mainSearchInput) {
        mainSearchInput.addEventListener('input', debounce(updateFilters, 300));
        mainSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                updateFilters();
            }
        });
    }
    
    // Add event listeners to quick filter dropdowns
    if (quickPriorityFilter) {
        quickPriorityFilter.addEventListener('change', updateFilters);
    }
    
    if (quickPipelineFilter) {
        quickPipelineFilter.addEventListener('change', updateFilters);
    }
    
    // Office selector for view mode (super admin only)
    const officeSelector = document.getElementById('office-selector');
    if (officeSelector) {
        officeSelector.addEventListener('change', function() {
            if (this.value) {
                const currentParams = new URLSearchParams(window.location.search);
                currentParams.set('view_mode', this.value);
                window.location.href = '?' + currentParams.toString();
            }
        });
    }
    
    // Office selector for view mode (super admin only)
    const officeSelector = document.getElementById('office-selector');
    if (officeSelector) {
        officeSelector.addEventListener('change', function() {
            if (this.value) {
                const currentParams = new URLSearchParams(window.location.search);
                currentParams.set('view_mode', this.value);
                window.location.href = '?' + currentParams.toString();
            }
        });
    }
    
    // Initialize table sorting
    initPeopleTableSorting();
});

// Table Sorting Function for People
function initPeopleTableSorting() {
    function sortTable(table, columnIndex, dataType) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        if (rows.length === 0) return;
        
        // Get current sort state
        const currentDir = table.dataset.sortDirection || 'asc';
        const currentCol = table.dataset.sortColumn;
        
        // Toggle direction if same column, otherwise start with asc
        let newDirection = 'asc';
        if (currentCol == columnIndex && currentDir === 'asc') {
            newDirection = 'desc';
        }
        
        // Store sort state
        table.dataset.sortDirection = newDirection;
        table.dataset.sortColumn = columnIndex;
        
        // Sort rows
        rows.sort((a, b) => {
            const aCell = a.cells[columnIndex];
            const bCell = b.cells[columnIndex];
            
            let aValue = aCell.textContent.trim().toLowerCase();
            let bValue = bCell.textContent.trim().toLowerCase();
            
            // Handle priority sorting
            if (dataType === 'priority') {
                const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                aValue = priorityOrder[aValue] || 0;
                bValue = priorityOrder[bValue] || 0;
                return newDirection === 'asc' ? aValue - bValue : bValue - aValue;
            }
            
            // Handle regular text sorting
            const comparison = aValue.localeCompare(bValue, undefined, { numeric: true });
            return newDirection === 'asc' ? comparison : -comparison;
        });
        
        // Re-append sorted rows
        rows.forEach(row => tbody.appendChild(row));
        
        console.log(`People: Sorted column ${columnIndex} in ${newDirection} direction`);
    }

    // Initialize sorting on people table
    console.log('DEBUG: Initializing people table sorting...');
    const table = document.querySelector('#people-table');
    console.log('DEBUG: Table found:', !!table);
    if (table) {
        const allHeaders = table.querySelectorAll('thead th');
        console.log('DEBUG: Headers found:', allHeaders.length);
        allHeaders.forEach((header, index) => {
            console.log(`DEBUG: Header ${index}: ${header.textContent}, has data-sortable: ${header.hasAttribute('data-sortable')}`);
            if (header.hasAttribute('data-sortable')) {
                // Remove existing listeners to avoid duplicates
                header.removeEventListener('click', header.sortHandler);
                
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';
                
                header.sortHandler = function() {
                    console.log(`Clicked people header ${index}: ${header.textContent}`);
                    sortTable(table, index, this.dataset.sortable);
                };
                
                header.addEventListener('click', header.sortHandler);
                console.log(`DEBUG: Added click listener to people header ${index}`);
            }
        });
        console.log('People table sorting initialized');
    } else {
        console.error('ERROR: People table not found!');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initPeopleTableSorting);

// Re-initialize after lazy loading (override existing function)
if (window.reinitializeSortableTables) {
    const originalReinit = window.reinitializeSortableTables;
    window.reinitializeSortableTables = function() {
        originalReinit();
        initPeopleTableSorting();
    };
} else {
    window.reinitializeSortableTables = initPeopleTableSorting;
}

// Handle email click - open Gmail compose in app
function openEmailCompose(email, name, contactId) {
    const composeUrl = `/communications/gmail/compose/?recipient=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}&contact_id=${contactId}`;
    window.location.href = composeUrl;
}

// Handle phone click - detect mobile and either dial or open communication log
function handlePhoneClick(phoneNumber, contactId, contactName) {
    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // Store call information for when user returns from phone app
        const callInfo = {
            phoneNumber: phoneNumber,
            contactId: contactId,
            contactName: contactName,
            timestamp: new Date().toISOString(),
            personDetailUrl: `/contacts/person/${contactId}/`
        };
        localStorage.setItem('pendingPhoneCall', JSON.stringify(callInfo));
        
        // Initiate the phone call
        window.location.href = `tel:${phoneNumber}`;
    } else {
        // On desktop, redirect to communications page and open the log modal
        window.location.href = `/communications/?open_log_modal=phone&contact_id=${contactId}`;
    }
}
</script>
{% endblock %}