{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Task List{% endblock %}

{% block page_title %}
    Tasks
    <a href="{% url 'tasks:task_create' %}" class="btn btn-primary btn-sm">
        <i class="fas fa-plus"></i> Create New Task
    </a>
{% endblock %}

{% block content %}
<!-- Select All Checkbox -->
<div class="row mb-3">
    <div class="col-12">
        <div class="form-check">
            <input type="checkbox" id="select-all" class="form-check-input">
            <label class="form-check-label" for="select-all">Select All</label>
        </div>
    </div>
</div>

<!-- View Mode Toggle -->
{% if can_toggle_view %}
<div class="w-100 mb-3">
    <div class="card">
        <div class="card-body py-2">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-eye me-2 text-muted"></i>
                        <span class="text-muted me-3">View Mode:</span>
                        <span class="badge bg-primary">{{ view_mode_display }}</span>
                    </div>
                    <!-- Mobile: vertical buttons -->
                    <div class="btn-group-vertical d-md-none" role="group" aria-label="View mode toggle">
                        <a href="?view_mode=default" 
                           class="btn btn-sm {% if current_view_mode == 'default' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            {% if user_role == 'super_admin' %}
                                <i class="fas fa-globe me-1"></i> All Offices
                            {% else %}
                                <i class="fas fa-building me-1"></i> My Office
                            {% endif %}
                        </a>
                        <a href="?view_mode=my_only" 
                           class="btn btn-sm {% if current_view_mode == 'my_only' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            <i class="fas fa-user me-1"></i> My Contacts Only
                        </a>
                    </div>
                    <!-- Desktop: horizontal buttons -->
                    <div class="d-none d-md-flex align-items-center gap-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-eye me-2 text-muted"></i>
                            <span class="text-muted me-3">View Mode:</span>
                            <span class="badge bg-primary">{{ view_mode_display }}</span>
                        </div>
                        <div class="btn-group" role="group" aria-label="View mode toggle">
                        <a href="?view_mode=default" 
                           class="btn btn-sm {% if current_view_mode == 'default' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            {% if user_role == 'super_admin' %}
                                <i class="fas fa-globe me-1"></i> All Offices
                            {% else %}
                                <i class="fas fa-building me-1"></i> My Office
                            {% endif %}
                        </a>
                        <a href="?view_mode=my_only" 
                           class="btn btn-sm {% if current_view_mode == 'my_only' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            <i class="fas fa-user me-1"></i> My Contacts Only
                        </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>
{% endif %}

    <!-- Filter Form -->
    <div class="card filter-card mb-4 w-100">
        <div class="card-body">
            <form method="get" id="filter-form">
                <!-- Mobile: stacked layout -->
                <div class="d-md-none">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" name="search" id="search" 
                                placeholder="Search tasks, people, churches..." value="{{ search_query }}" autocomplete="off">
                        </div>
                        <div class="col-6">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" name="status" id="status">
                                <option value="">All Statuses</option>
                                <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="in_progress" {% if current_status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label for="priority" class="form-label">Priority</label>
                            <select class="form-select" name="priority" id="priority">
                                <option value="">All Priorities</option>
                                <option value="high" {% if current_priority == 'high' %}selected{% endif %}>High</option>
                                <option value="medium" {% if current_priority == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="low" {% if current_priority == 'low' %}selected{% endif %}>Low</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label for="assigned_to" class="form-label">Assigned To</label>
                            <select class="form-select" name="assigned_to" id="assigned_to">
                                <option value="">All Tasks</option>
                                <option value="me" {% if current_assigned == 'me' %}selected{% endif %}>My Tasks</option>
                                <option value="unassigned" {% if current_assigned == 'unassigned' %}selected{% endif %}>Unassigned</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label for="due" class="form-label">Due Date</label>
                            <select class="form-select" name="due" id="due">
                                <option value="">All Dates</option>
                                <option value="overdue" {% if current_due == 'overdue' %}selected{% endif %}>Overdue</option>
                                <option value="today" {% if current_due == 'today' %}selected{% endif %}>Today</option>
                                <option value="week" {% if current_due == 'week' %}selected{% endif %}>This Week</option>
                                <option value="month" {% if current_due == 'month' %}selected{% endif %}>This Month</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Desktop: horizontal layout all on one line -->
                <div class="d-none d-md-flex align-items-end gap-3">
                    <div>
                        <label for="search-desktop" class="form-label">Search</label>
                        <input type="text" class="form-control" name="search" id="search-desktop" 
                            placeholder="Search tasks, people, churches..." value="{{ search_query }}" autocomplete="off" style="min-width: 200px;">
                    </div>
                    <div>
                        <label for="status-desktop" class="form-label">Status</label>
                        <select class="form-select" name="status" id="status-desktop">
                            <option value="">All Statuses</option>
                            <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="in_progress" {% if current_status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                        </select>
                    </div>
                    <div>
                        <label for="priority-desktop" class="form-label">Priority</label>
                        <select class="form-select" name="priority" id="priority-desktop">
                            <option value="">All Priorities</option>
                            <option value="high" {% if current_priority == 'high' %}selected{% endif %}>High</option>
                            <option value="medium" {% if current_priority == 'medium' %}selected{% endif %}>Medium</option>
                            <option value="low" {% if current_priority == 'low' %}selected{% endif %}>Low</option>
                        </select>
                    </div>
                    <div>
                        <label for="assigned_to-desktop" class="form-label">Assigned To</label>
                        <select class="form-select" name="assigned_to" id="assigned_to-desktop">
                            <option value="">All Tasks</option>
                            <option value="me" {% if current_assigned == 'me' %}selected{% endif %}>My Tasks</option>
                            <option value="unassigned" {% if current_assigned == 'unassigned' %}selected{% endif %}>Unassigned</option>
                        </select>
                    </div>
                    <div>
                        <label for="due-desktop" class="form-label">Due Date</label>
                        <select class="form-select" name="due" id="due-desktop">
                            <option value="">All Dates</option>
                            <option value="overdue" {% if current_due == 'overdue' %}selected{% endif %}>Overdue</option>
                            <option value="today" {% if current_due == 'today' %}selected{% endif %}>Today</option>
                            <option value="week" {% if current_due == 'week' %}selected{% endif %}>This Week</option>
                            <option value="month" {% if current_due == 'month' %}selected{% endif %}>This Month</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Operations Bar -->
    <div class="card mb-3" id="bulk-operations" style="display: none;">
        <div class="card-body py-2">
            <!-- Mobile: stacked layout -->
            <div class="d-md-none">
                <div class="mb-2">
                    <span class="text-muted"><span id="selected-count">0</span> selected</span>
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <form method="post" action="{% url 'tasks:bulk_delete' %}" onsubmit="return confirm('Are you sure you want to delete the selected tasks?');">
                            {% csrf_token %}
                            <input type="hidden" name="task_ids" id="bulk-delete-ids-mobile">
                            <button type="submit" class="btn btn-danger btn-sm w-100">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                        </form>
                    </div>
                    <div class="col-6">
                        <form method="post" action="{% url 'tasks:bulk_update_status' %}">
                            {% csrf_token %}
                            <input type="hidden" name="task_ids" id="bulk-status-ids-mobile">
                            <select name="status" class="form-select form-select-sm">
                                <option value="">Change Status...</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </form>
                    </div>
                    <div class="col-6">
                        <form method="post" action="{% url 'tasks:bulk_update_priority' %}">
                            {% csrf_token %}
                            <input type="hidden" name="task_ids" id="bulk-priority-ids-mobile">
                            <select name="priority" class="form-select form-select-sm">
                                <option value="">Change Priority...</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </form>
                    </div>
                    <div class="col-6">
                        <form method="post" action="{% url 'tasks:bulk_assign_user' %}">
                            {% csrf_token %}
                            <input type="hidden" name="task_ids" id="bulk-user-ids-mobile">
                            <select name="user_id" class="form-select form-select-sm">
                                <option value="">Assign to User...</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.get_full_name|default:user.email }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>
                    <div class="col-6">
                        <form method="post" action="{% url 'tasks:bulk_complete' %}">
                            {% csrf_token %}
                            <input type="hidden" name="task_ids" id="bulk-complete-ids-mobile">
                            <button type="submit" class="btn btn-success btn-sm w-100">
                                <i class="fas fa-check"></i> Complete Selected
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Desktop: horizontal layout all on one line -->
            <div class="d-none d-md-flex align-items-center gap-3 flex-wrap">
                <span class="text-muted"><span id="selected-count-desktop">0</span> selected</span>
                
                <!-- Bulk Delete -->
                <form method="post" action="{% url 'tasks:bulk_delete' %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete the selected tasks?');">
                    {% csrf_token %}
                    <input type="hidden" name="task_ids" id="bulk-delete-ids">
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                </form>
                
                <!-- Bulk Status Update -->
                <form method="post" action="{% url 'tasks:bulk_update_status' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="task_ids" id="bulk-status-ids">
                    <select name="status" class="form-select form-select-sm" style="width: auto; display: inline;">
                        <option value="">Change Status...</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                    <button type="submit" class="btn btn-outline-secondary btn-sm">Update</button>
                </form>
                
                <!-- Bulk Priority Update -->
                <form method="post" action="{% url 'tasks:bulk_update_priority' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="task_ids" id="bulk-priority-ids">
                    <select name="priority" class="form-select form-select-sm" style="width: auto; display: inline;">
                        <option value="">Change Priority...</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                    <button type="submit" class="btn btn-outline-secondary btn-sm">Update</button>
                </form>
                
                <!-- Bulk User Assignment -->
                <form method="post" action="{% url 'tasks:bulk_assign_user' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="task_ids" id="bulk-user-ids">
                    <select name="user_id" class="form-select form-select-sm" style="width: auto; display: inline;">
                        <option value="">Assign to User...</option>
                        {% for user in users %}
                        <option value="{{ user.id }}">{{ user.get_full_name|default:user.email }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-outline-secondary btn-sm">Assign</button>
                </form>
                
                <!-- Bulk Office Assignment -->
                <form method="post" action="{% url 'tasks:bulk_assign_office' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="task_ids" id="bulk-office-ids">
                    <select name="office_id" class="form-select form-select-sm" style="width: auto; display: inline;">
                        <option value="">Assign to Office...</option>
                        {% for office in offices %}
                        <option value="{{ office.id }}">{{ office.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-outline-secondary btn-sm">Assign</button>
                </form>
                
                <!-- Bulk Complete -->
                <form method="post" action="{% url 'tasks:bulk_complete' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="task_ids" id="bulk-complete-ids">
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="fas fa-check"></i> Complete Selected
                    </button>
                </form>
            </div>
        </div>
    </div>

    {% if tasks %}
        <div class="list-group">
            {% for task in page_obj %} {# Use page_obj for paginated tasks #}
                <div id="task-item-{{ task.pk }}" class="list-group-item list-group-item-action flex-column align-items-start {% if task.status == 'completed' %}task-completed{% endif %}">
                    <div class="d-flex align-items-start">
                        <!-- Checkbox for bulk operations -->
                        <input type="checkbox" name="task_ids" value="{{ task.pk }}" class="form-check-input task-checkbox me-3 mt-1">
                        <div class="flex-grow-1">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                        <div>
                            <a href="{{ task.get_absolute_url }}" class="text-decoration-none">
                                <h5 class="mb-1 {% if task.status == 'completed' %}text-decoration-line-through{% endif %}">{{ task.title }}</h5>
                            </a>
                            <small class="task-status-display">Status: {{ task.get_status_display }}</small> | 
                            <small>Priority: {{ task.get_priority_display }}</small>
                            {% if task.is_recurring_template %}
                                <small> | <i class="fas fa-sync-alt text-info"></i> Recurring Template</small>
                            {% elif task.parent_task %}
                                <small> | <i class="fas fa-link text-muted"></i> Recurring Instance</small>
                            {% endif %}
                            {% if task.status == 'completed' and task.completed_at %}
                                <small class="text-muted task-completed-at-display"> | Completed: {{ task.completed_at|date:"Y-m-d" }}</small>
                            {% else %}
                                <small> | Due: {{ task.due_date|date:"Y-m-d"|default:"N/A" }}</small>
                            {% endif %}
                        </div>
                        <div>
                            {% if task.status != 'completed' %}
                            <button class="btn btn-sm btn-outline-success mark-complete-btn" data-task-id="{{ task.pk }}">
                                <i class="fas fa-check"></i> Complete
                            </button>
                            {% endif %}
                            <a href="{% url 'tasks:task_update' task.pk %}" class="btn btn-sm btn-outline-secondary ms-1"><i class="fas fa-edit"></i></a>
                            <a href="{% url 'tasks:task_delete' task.pk %}" class="btn btn-sm btn-outline-danger ms-1"><i class="fas fa-trash"></i></a>
                        </div>
                    </div>
                    <p class="mb-1 mt-1">{{ task.description|truncatewords:20|default:"" }}</p>
                    
                    {# Display person/church/contact prominently #}
                    {% if task.person %}
                        <div class="mb-1">
                            <small class="text-info"><i class="fas fa-user"></i> <strong>Person:</strong> 
                                <a href="{% url 'contacts:person_detail' task.person.pk %}" class="text-info">
                                    {{ task.person.contact.first_name }} {{ task.person.contact.last_name }}
                                </a>
                            </small>
                        </div>
                    {% elif task.church and task.church.pk %}
                        <div class="mb-1">
                            <small class="text-info"><i class="fas fa-church"></i> <strong>Church:</strong> 
                                <a href="{% url 'churches:church_detail' task.church.pk %}" class="text-info">
                                    {{ task.church.name }}
                                </a>
                            </small>
                        </div>
                    {% elif task.contact %}
                        <div class="mb-1">
                            <small class="text-info">
                                <i class="fas fa-{% if task.contact.type == 'person' %}user{% else %}church{% endif %}"></i> 
                                <strong>Contact:</strong> 
                                {% if task.contact.type == 'person' and task.contact.person and task.contact.person.pk %}
                                    <a href="{% url 'contacts:person_detail' task.contact.person.pk %}" class="text-info">
                                        {{ task.contact.first_name }} {{ task.contact.last_name }}
                                    </a>
                                {% elif task.contact.type == 'church' and task.contact.church and task.contact.church.pk %}
                                    <a href="{% url 'churches:church_detail' task.contact.church.pk %}" class="text-info">
                                        {{ task.contact.church_name }}
                                    </a>
                                {% else %}
                                    {{ task.contact.first_name|default:"" }} {{ task.contact.last_name|default:"" }}{{ task.contact.church_name|default:"" }}
                                {% endif %}
                            </small>
                        </div>
                    {% endif %}
                    
                    {% if task.assigned_to %}<small class="d-block text-muted">Assigned to: {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}</small>{% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% include "partials/_pagination.html" %}

    {% else %}
        <div class="alert alert-info" role="alert">
            No tasks found.
            {% if request.GET %}
                Try adjusting your filters or <a href="{% url 'tasks:task_list' %}" class="alert-link">clear filters</a>.
            {% else %}
                <a href="{% url 'tasks:task_create' %}" class="alert-link">Create a new task?</a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dynamic filtering functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const searchInput = document.getElementById('search');
    const searchInputDesktop = document.getElementById('search-desktop');
    let searchTimer;
    
    // Add dynamic search for mobile
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(function() {
                filterForm.submit();
            }, 300); // 300ms delay
        });
    }
    
    // Add dynamic search for desktop
    if (searchInputDesktop) {
        searchInputDesktop.addEventListener('input', function() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(function() {
                filterForm.submit();
            }, 300); // 300ms delay
        });
    }
    
    // Auto-submit form when filters change
    const filterSelects = filterForm.querySelectorAll('select');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            filterForm.submit();
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.mark-complete-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const taskId = this.dataset.taskId;
            const url = `/tasks/${taskId}/complete/`;
            const taskItem = document.getElementById(`task-item-${taskId}`);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (taskItem) {
                        taskItem.classList.add('task-completed');
                        const titleEl = taskItem.querySelector('h5');
                        if (titleEl) titleEl.classList.add('text-decoration-line-through');
                        
                        const statusEl = taskItem.querySelector('.task-status-display');
                        if(statusEl) statusEl.textContent = `Status: ${data.status}`;

                        const completedAtEl = taskItem.querySelector('.task-completed-at-display');
                        if(completedAtEl && data.completed_at_formatted) {
                            completedAtEl.textContent = ` | Completed: ${data.completed_at_formatted}`;
                            completedAtEl.classList.remove('d-none'); // Ensure it's visible
                        } else if (completedAtEl) {
                             // If it exists but no date, create or update it
                            let smallCompletedText = taskItem.querySelector('.task-completed-at-display');
                            if (!smallCompletedText) { // If it doesn't exist, find where to insert or append
                                const statusPriorityContainer = taskItem.querySelector('.task-status-display').parentNode;
                                if(statusPriorityContainer && data.completed_at_formatted) {
                                   statusPriorityContainer.insertAdjacentHTML('beforeend', `<small class="text-muted task-completed-at-display"> | Completed: ${data.completed_at_formatted}</small>`);
                                }
                            }
                        }
                    }
                    this.remove(); // Remove the button
                } else {
                    alert('Failed to mark task as complete: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error marking task complete:', error);
                alert('An error occurred while marking the task as complete.');
            });
        });
    });
});

// Bulk operations functionality
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all');
    const taskCheckboxes = document.querySelectorAll('.task-checkbox');
    const bulkOperationsBar = document.getElementById('bulk-operations');
    const selectedCountSpan = document.getElementById('selected-count');
    
    // Handle select all functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            taskCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkOperations();
        });
    }
    
    // Handle individual checkbox changes
    taskCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkOperations();
            updateSelectAllState();
        });
    });
    
    function updateBulkOperations() {
        const checkedBoxes = document.querySelectorAll('.task-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (count > 0) {
            bulkOperationsBar.style.display = 'block';
            selectedCountSpan.textContent = count;
            
            // Update desktop count
            const desktopCount = document.getElementById('selected-count-desktop');
            if (desktopCount) {
                desktopCount.textContent = count;
            }
            
            // Update all hidden task_ids inputs
            const taskIds = Array.from(checkedBoxes).map(cb => cb.value).join(',');
            
            // Desktop inputs
            const deleteIds = document.getElementById('bulk-delete-ids');
            const statusIds = document.getElementById('bulk-status-ids');
            const priorityIds = document.getElementById('bulk-priority-ids');
            const userIds = document.getElementById('bulk-user-ids');
            const officeIds = document.getElementById('bulk-office-ids');
            const completeIds = document.getElementById('bulk-complete-ids');
            
            if (deleteIds) deleteIds.value = taskIds;
            if (statusIds) statusIds.value = taskIds;
            if (priorityIds) priorityIds.value = taskIds;
            if (userIds) userIds.value = taskIds;
            if (officeIds) officeIds.value = taskIds;
            if (completeIds) completeIds.value = taskIds;
            
            // Mobile inputs
            const deleteIdsMobile = document.getElementById('bulk-delete-ids-mobile');
            const statusIdsMobile = document.getElementById('bulk-status-ids-mobile');
            const priorityIdsMobile = document.getElementById('bulk-priority-ids-mobile');
            const userIdsMobile = document.getElementById('bulk-user-ids-mobile');
            const completeIdsMobile = document.getElementById('bulk-complete-ids-mobile');
            
            if (deleteIdsMobile) deleteIdsMobile.value = taskIds;
            if (statusIdsMobile) statusIdsMobile.value = taskIds;
            if (priorityIdsMobile) priorityIdsMobile.value = taskIds;
            if (userIdsMobile) userIdsMobile.value = taskIds;
            if (completeIdsMobile) completeIdsMobile.value = taskIds;
        } else {
            bulkOperationsBar.style.display = 'none';
        }
    }
    
    function updateSelectAllState() {
        const checkedCount = document.querySelectorAll('.task-checkbox:checked').length;
        const totalCount = taskCheckboxes.length;
        
        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === totalCount) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
});
</script>
{% endblock %}