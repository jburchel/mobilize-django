{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Task List{% endblock %}

{% block page_title %}Tasks{% endblock %}

{% block page_actions %}
    <a href="{% url 'tasks:task_create' %}" class="btn btn-primary btn-sm px-3">
        <i class="fas fa-plus me-1"></i> Create New Task
    </a>
{% endblock %}

{% block content %}
<!-- View Mode Toggle for Admins -->
{% if can_toggle_view %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="d-flex align-items-center gap-2 flex-nowrap" style="overflow-x: auto;">
                    <div class="d-flex align-items-center gap-2" style="flex-shrink: 0;">
                        <i class="fas fa-eye text-muted"></i>
                        <span class="text-muted">View Mode:</span>
                    </div>
                    
                    {% if user_role == 'super_admin' %}
                        <!-- Toggle Buttons for Super Admin -->
                        <div class="btn-group" role="group" aria-label="View mode toggle" style="flex-shrink: 0;">
                            <a href="?view_mode=default{% if search_query %}&search={{ search_query }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_priority %}&priority={{ current_priority }}{% endif %}{% if current_assigned %}&assigned_to={{ current_assigned }}{% endif %}{% if current_due %}&due={{ current_due }}{% endif %}" 
                               class="btn btn-sm {% if current_view_mode == 'default' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-globe me-1"></i> All Offices
                            </a>
                            <a href="?view_mode=my_only{% if search_query %}&search={{ search_query }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_priority %}&priority={{ current_priority }}{% endif %}{% if current_assigned %}&assigned_to={{ current_assigned }}{% endif %}{% if current_due %}&due={{ current_due }}{% endif %}" 
                               class="btn btn-sm {% if current_view_mode == 'my_only' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-user me-1"></i> My Tasks Only
                            </a>
                        </div>
                        <!-- Office Selector Dropdown -->
                        <select id="office-selector" class="form-select form-select-sm" style="width: 140px; flex-shrink: 0;">
                            <option value="default" {% if current_view_mode == "default" %}selected{% endif %}>All Offices</option>
                            <option value="" disabled>-------------------</option>
                            {% for office in all_offices %}
                            <option value="office_{{ office.id }}" 
                                {% if current_view_mode == 'office_'|add:office.id|stringformat:"s" %}selected{% endif %}>
                                {{ office.name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <!-- Toggle Buttons for Office Admin -->
                        <div class="btn-group" role="group" aria-label="View mode toggle" style="flex-shrink: 0;">
                            <a href="?view_mode=default{% if search_query %}&search={{ search_query }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_priority %}&priority={{ current_priority }}{% endif %}{% if current_assigned %}&assigned_to={{ current_assigned }}{% endif %}{% if current_due %}&due={{ current_due }}{% endif %}" 
                               class="btn btn-sm {% if current_view_mode == 'default' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-building me-1"></i> My Office
                            </a>
                            <a href="?view_mode=my_only{% if search_query %}&search={{ search_query }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_priority %}&priority={{ current_priority }}{% endif %}{% if current_assigned %}&assigned_to={{ current_assigned }}{% endif %}{% if current_due %}&due={{ current_due }}{% endif %}" 
                               class="btn btn-sm {% if current_view_mode == 'my_only' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-user me-1"></i> My Tasks Only
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Bulk Operations Bar -->
<div class="card mb-3" id="bulk-operations" style="display: none;">
    <div class="card-body py-2">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <span class="text-muted"><span id="selected-count">0</span> selected</span>
            
            <!-- Bulk Delete -->
            <form method="post" action="{% url 'tasks:bulk_delete' %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete the selected tasks?');">
                {% csrf_token %}
                <input type="hidden" name="task_ids" id="bulk-delete-ids">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </form>
            
            <!-- Bulk Status Update -->
            <form method="post" action="{% url 'tasks:bulk_update_status' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="task_ids" id="bulk-status-ids">
                <select name="status" class="form-select form-select-sm" style="width: auto; display: inline;">
                    <option value="">Change Status...</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Update</button>
            </form>
            
            <!-- Bulk Priority Update -->
            <form method="post" action="{% url 'tasks:bulk_update_priority' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="task_ids" id="bulk-priority-ids">
                <select name="priority" class="form-select form-select-sm" style="width: auto; display: inline;">
                    <option value="">Change Priority...</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Update</button>
            </form>
            
            <!-- Bulk User Assignment -->
            <form method="post" action="{% url 'tasks:bulk_assign_user' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="task_ids" id="bulk-user-ids">
                <select name="user_id" class="form-select form-select-sm" style="width: auto; display: inline;">
                    <option value="">Assign to User...</option>
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.get_full_name|default:user.email }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Assign</button>
            </form>
            
            <!-- Bulk Complete -->
            <form method="post" action="{% url 'tasks:bulk_complete' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="task_ids" id="bulk-complete-ids">
                <button type="submit" class="btn btn-success btn-sm">
                    <i class="fas fa-check"></i> Complete Selected
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Prominent Search Bar -->
<div class="card mb-3">
    <div class="card-body py-3">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-light">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" id="main-search-input" class="form-control form-control-lg" 
                           placeholder="Search tasks by title, description, person, or church..." 
                           value="{{ search_query }}" autocomplete="off">
                </div>
            </div>
            <div class="col-md-8 mt-2 mt-md-0">
                <div class="d-flex gap-2">
                    <select id="quick-status-filter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="in_progress" {% if current_status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                    </select>
                    <select id="quick-priority-filter" class="form-select">
                        <option value="">All Priorities</option>
                        <option value="high" {% if current_priority == 'high' %}selected{% endif %}>High</option>
                        <option value="medium" {% if current_priority == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="low" {% if current_priority == 'low' %}selected{% endif %}>Low</option>
                    </select>
                    <select id="quick-due-filter" class="form-select">
                        <option value="">All Dates</option>
                        <option value="overdue" {% if current_due == 'overdue' %}selected{% endif %}>Overdue</option>
                        <option value="today" {% if current_due == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if current_due == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if current_due == 'month' %}selected{% endif %}>This Month</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <!-- Advanced Filters Toggle -->
        <div class="mb-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#advanced-filters" aria-expanded="false">
                <i class="fas fa-sliders-h me-1"></i> Advanced Filters
            </button>
        </div>
        
        <!-- Advanced Filters (Collapsible) -->
        <div class="collapse" id="advanced-filters">
            <form method="get" class="mb-3" id="filter-form" onsubmit="event.preventDefault(); return false;">
                <!-- Desktop: Single row layout -->
                <div class="d-none d-md-flex align-items-center gap-2 flex-nowrap">
                    <input type="text" name="search" value="{{ search_query }}" placeholder="Search tasks..." class="form-control" id="search-input" style="flex: 1; min-width: 200px;">
                    <select name="status" class="form-select" id="status-filter" style="width: 140px; flex-shrink: 0;">
                        <option value="">All Statuses</option>
                        <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="in_progress" {% if current_status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                    </select>
                    <select name="priority" class="form-select" id="priority-filter" style="width: 140px; flex-shrink: 0;">
                        <option value="">All Priorities</option>
                        <option value="high" {% if current_priority == 'high' %}selected{% endif %}>High</option>
                        <option value="medium" {% if current_priority == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="low" {% if current_priority == 'low' %}selected{% endif %}>Low</option>
                    </select>
                    <select name="assigned_to" class="form-select" id="assigned-filter" style="width: 140px; flex-shrink: 0;">
                        <option value="">All Tasks</option>
                        <option value="me" {% if current_assigned == 'me' %}selected{% endif %}>My Tasks</option>
                        <option value="unassigned" {% if current_assigned == 'unassigned' %}selected{% endif %}>Unassigned</option>
                    </select>
                    <select name="due" class="form-select" id="due-filter" style="width: 120px; flex-shrink: 0;">
                        <option value="">All Dates</option>
                        <option value="overdue" {% if current_due == 'overdue' %}selected{% endif %}>Overdue</option>
                        <option value="today" {% if current_due == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if current_due == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if current_due == 'month' %}selected{% endif %}>This Month</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary btn-sm" style="flex-shrink: 0;" onclick="location.reload();">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <!-- Mobile: Stacked layout -->
                <div class="d-md-none">
                    <div class="row g-3">
                        <div class="col-12">
                            <input type="text" name="search" value="{{ search_query }}" placeholder="Search tasks..." class="form-control" id="search-input-mobile">
                        </div>
                        <div class="col-6">
                            <select name="status" class="form-select" id="status-filter-mobile">
                                <option value="">All Statuses</option>
                                <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="in_progress" {% if current_status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select name="priority" class="form-select" id="priority-filter-mobile">
                                <option value="">All Priorities</option>
                                <option value="high" {% if current_priority == 'high' %}selected{% endif %}>High</option>
                                <option value="medium" {% if current_priority == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="low" {% if current_priority == 'low' %}selected{% endif %}>Low</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select name="assigned_to" class="form-select" id="assigned-filter-mobile">
                                <option value="">All Tasks</option>
                                <option value="me" {% if current_assigned == 'me' %}selected{% endif %}>My Tasks</option>
                                <option value="unassigned" {% if current_assigned == 'unassigned' %}selected{% endif %}>Unassigned</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select name="due" class="form-select" id="due-filter-mobile">
                                <option value="">All Dates</option>
                                <option value="overdue" {% if current_due == 'overdue' %}selected{% endif %}>Overdue</option>
                                <option value="today" {% if current_due == 'today' %}selected{% endif %}>Today</option>
                                <option value="week" {% if current_due == 'week' %}selected{% endif %}>This Week</option>
                                <option value="month" {% if current_due == 'month' %}selected{% endif %}>This Month</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="location.reload();">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Task List with Dynamic Loading -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="select-all" class="form-check-input">
                        </th>
                        <th>Task</th>
                        <th>Contact</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Due Date</th>
                        <th>Assigned To</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="task-table-body">
                    <!-- Tasks will be loaded dynamically via JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- No Results Message -->
        <div id="no-results" class="text-center text-muted py-4" style="display: none;">
            No tasks found. <a href="{% url 'tasks:task_create' %}">Create the first task</a>.
        </div>
        
        <!-- Pagination Status and Load More Button -->
        <div class="d-flex justify-content-between align-items-center mt-3" id="pagination-controls">
            <div class="text-muted">
                <span id="showing-text">Showing <span id="current-count">0</span> of <span id="total-count">0</span> tasks</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center gap-2">
                    <label for="per-page-select" class="form-label mb-0 text-muted">Show:</label>
                    <select id="per-page-select" class="form-select form-select-sm" style="width: auto;">
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" id="load-more-btn" style="display: none;">
                        Load More <span id="per-page-count">25</span>
                    </button>
                    <span class="text-muted" id="end-reached" style="display: none;">
                        <i class="fas fa-check-circle text-success"></i> All tasks loaded
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/lazy-loading.js' %}?v=1750793997"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize lazy loader for task list
    const taskLoader = new LazyLoader({
        tableBody: document.getElementById('task-table-body'),
        apiUrl: '{% url "tasks:task_list_api" %}',
        perPage: 25,
        enableInfiniteScroll: false,  // Disable auto-scroll for manual pagination
        filters: {
            search: '{{ search_query }}',
            status: '{{ current_status }}',
            priority: '{{ current_priority }}',
            assigned_to: '{{ current_assigned }}',
            due: '{{ current_due }}'
        }
    });
    
    // Override the row template for task-specific rendering
    taskLoader.getRowTemplate = function(item) {
        return `
            <td>
                <input type="checkbox" name="task_ids" value="${item.id}" class="form-check-input task-checkbox">
            </td>
            <td>
                <a href="${item.detail_url}" class="text-decoration-none">
                    <strong class="${item.status === 'completed' ? 'text-decoration-line-through' : ''}">${item.title}</strong>
                </a>
                ${item.description ? `<br><small class="text-muted">${item.description.substring(0, 80)}${item.description.length > 80 ? '...' : ''}</small>` : ''}
                ${item.is_recurring_template ? '<br><small class="text-info"><i class="fas fa-sync-alt me-1"></i>Recurring Template</small>' : ''}
                ${item.parent_task ? '<br><small class="text-muted"><i class="fas fa-link me-1"></i>Recurring Instance</small>' : ''}
            </td>
            <td>
                ${item.contact_name ? 
                    `<a href="${item.contact_url}" class="text-decoration-none">
                        <i class="${item.contact_icon} me-1"></i>${item.contact_name}
                    </a>` : '-'}
            </td>
            <td>${this.getStatusBadge(item.status, item.status_display)}</td>
            <td>${this.getPriorityBadge(item.priority, item.priority_display)}</td>
            <td>
                ${item.status === 'completed' && item.completed_at ? 
                    `<small class="text-success">Completed: ${item.completed_at_formatted}</small>` :
                    `${item.due_date ? item.due_date_formatted : '<span class="text-muted">No due date</span>'}`}
            </td>
            <td>${item.assigned_to_name || '-'}</td>
            <td>${this.getActionButtons(item)}</td>
        `;
    };
    
    // Override getStatusBadge for task-specific status badges
    taskLoader.getStatusBadge = function(status, statusDisplay) {
        const badges = {
            'pending': '<span class="badge bg-warning text-dark">Pending</span>',
            'in_progress': '<span class="badge bg-primary">In Progress</span>',
            'completed': '<span class="badge bg-success">Completed</span>'
        };
        return badges[status] || `<span class="badge bg-secondary">${statusDisplay || status}</span>`;
    };
    
    // Override getPriorityBadge for task-specific priority badges
    taskLoader.getPriorityBadge = function(priority, priorityDisplay) {
        const badges = {
            'low': '<span class="badge bg-light text-dark">Low</span>',
            'medium': '<span class="badge bg-info">Medium</span>',
            'high': '<span class="badge bg-danger">High</span>'
        };
        return badges[priority] || `<span class="badge bg-secondary">${priorityDisplay || priority}</span>`;
    };
    
    // Override getActionButtons for task-specific actions
    taskLoader.getActionButtons = function(item) {
        return `
            <div class="btn-group">
                ${item.status !== 'completed' ? 
                    `<button class="btn btn-sm btn-outline-success mark-complete-btn" data-task-id="${item.id}">
                        <i class="fas fa-check"></i>
                    </button>` : ''}
                <a href="${item.edit_url}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-edit"></i>
                </a>
                <a href="${item.detail_url}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i>
                </a>
                <a href="${item.delete_url}" class="btn btn-sm btn-outline-danger">
                    <i class="fas fa-trash"></i>
                </a>
            </div>
        `;
    };
    
    // Set up pagination controls
    const loadMoreBtn = document.getElementById('load-more-btn');
    const perPageSelect = document.getElementById('per-page-select');
    const perPageCount = document.getElementById('per-page-count');
    
    // Load more button click handler
    if (!taskLoader.enableInfiniteScroll) {
        loadMoreBtn.addEventListener('click', () => {
            taskLoader.loadMore();
        });
    }
    
    // Per-page selector change handler
    perPageSelect.addEventListener('change', (e) => {
        const newPerPage = parseInt(e.target.value);
        taskLoader.perPage = newPerPage;
        perPageCount.textContent = newPerPage;
        taskLoader.resetAndLoad();
    });
    
    // Load initial data
    taskLoader.loadMore();
    
    // Bulk operations management
    const selectAll = document.getElementById('select-all');
    const bulkOpsBar = document.getElementById('bulk-operations');
    const selectedCount = document.getElementById('selected-count');
    
    window.updateBulkOperations = function() {
        const checkboxes = document.querySelectorAll('.task-checkbox');
        const selected = document.querySelectorAll('.task-checkbox:checked');
        const count = selected.length;
        
        selectedCount.textContent = count;
        bulkOpsBar.style.display = count > 0 ? 'block' : 'none';
        
        // Update all hidden inputs for bulk operations
        const ids = Array.from(selected).map(cb => cb.value).join(',');
        document.getElementById('bulk-delete-ids').value = ids;
        document.getElementById('bulk-status-ids').value = ids;
        document.getElementById('bulk-priority-ids').value = ids;
        document.getElementById('bulk-user-ids').value = ids;
        document.getElementById('bulk-complete-ids').value = ids;
        
        // Update select all checkbox state
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        const noneChecked = Array.from(checkboxes).every(cb => !cb.checked);
        
        selectAll.checked = allChecked;
        selectAll.indeterminate = !allChecked && !noneChecked;
    };
    
    // Select all functionality
    selectAll.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.task-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBulkOperations();
    });
    
    // Dynamic Search Functionality
    const mainSearchInput = document.getElementById('main-search-input');
    const quickStatusFilter = document.getElementById('quick-status-filter');
    const quickPriorityFilter = document.getElementById('quick-priority-filter');
    const quickDueFilter = document.getElementById('quick-due-filter');
    
    // Debounce function for dynamic search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Update filters and reload data
    function updateFilters() {
        const searchQuery = mainSearchInput ? mainSearchInput.value : '';
        const status = quickStatusFilter ? quickStatusFilter.value : '';
        const priority = quickPriorityFilter ? quickPriorityFilter.value : '';
        const due = quickDueFilter ? quickDueFilter.value : '';
        
        taskLoader.updateFilters({
            search: searchQuery,
            status: status,
            priority: priority,
            due: due
        });
        
        // Reset and reload data with new filters
        taskLoader.resetAndLoad();
    }
    
    // Add event listeners for dynamic search
    if (mainSearchInput) {
        mainSearchInput.addEventListener('input', debounce(updateFilters, 300));
        mainSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                updateFilters();
            }
        });
    }
    
    if (quickStatusFilter) {
        quickStatusFilter.addEventListener('change', updateFilters);
    }
    
    if (quickPriorityFilter) {
        quickPriorityFilter.addEventListener('change', updateFilters);
    }
    
    if (quickDueFilter) {
        quickDueFilter.addEventListener('change', updateFilters);
    }
    
    // Office selector for view mode (super admin only)
    const officeSelector = document.getElementById('office-selector');
    if (officeSelector) {
        officeSelector.addEventListener('change', function() {
            if (this.value) {
                const currentParams = new URLSearchParams(window.location.search);
                currentParams.set('view_mode', this.value);
                window.location.href = '?' + currentParams.toString();
            }
        });
    }
    
    // Handle bulk operation form submissions
    document.querySelectorAll('form select[name="status"]').forEach(select => {
        select.addEventListener('change', function() {
            if (this.value) {
                this.closest('form').submit();
            }
        });
    });
    
    document.querySelectorAll('form select[name="priority"]').forEach(select => {
        select.addEventListener('change', function() {
            if (this.value) {
                this.closest('form').submit();
            }
        });
    });
    
    document.querySelectorAll('form select[name="user_id"]').forEach(select => {
        select.addEventListener('change', function() {
            if (this.value) {
                this.closest('form').submit();
            }
        });
    });
});

// Task completion functionality
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', function() {
    // Handle task completion buttons (delegated event handling for dynamic content)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('mark-complete-btn') || e.target.closest('.mark-complete-btn')) {
            e.preventDefault();
            const button = e.target.classList.contains('mark-complete-btn') ? e.target : e.target.closest('.mark-complete-btn');
            const taskId = button.dataset.taskId;
            const url = `/tasks/${taskId}/complete/`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the UI
                    const row = button.closest('tr');
                    if (row) {
                        const titleLink = row.querySelector('td:nth-child(2) a strong');
                        if (titleLink) titleLink.classList.add('text-decoration-line-through');
                        
                        const statusCell = row.querySelector('td:nth-child(4)');
                        if (statusCell) statusCell.innerHTML = '<span class="badge bg-success">Completed</span>';
                        
                        const dueDateCell = row.querySelector('td:nth-child(6)');
                        if (dueDateCell && data.completed_at_formatted) {
                            dueDateCell.innerHTML = `<small class="text-success">Completed: ${data.completed_at_formatted}</small>`;
                        }
                    }
                    button.remove(); // Remove the complete button
                } else {
                    alert('Failed to mark task as complete: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error marking task complete:', error);
                alert('An error occurred while marking the task as complete.');
            });
        }
    });
    
    // Handle checkbox changes for bulk operations (delegated event handling)
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('task-checkbox')) {
            updateBulkOperations();
        }
    });
});
</script>
{% endblock %}