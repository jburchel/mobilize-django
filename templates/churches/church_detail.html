{% extends 'base.html' %}
{% load static %}

{% block title %}{{ church.name|default:church.contact.church_name }}{% endblock %}

{% block page_title %}{{ church.name|default:church.contact.church_name }}{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <a href="{% url 'churches:church_edit' church.pk %}" class="btn btn-primary">
        <i class="fas fa-edit"></i> Edit
    </a>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-ellipsis-v"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" onclick="addChurchMember()">
                <i class="fas fa-user-plus me-2"></i> Add Person
            </a></li>
            <li><a class="dropdown-item" href="/communications/?contact_id={{ church.contact.id }}">
                <i class="fas fa-comment-alt me-2"></i> View Communications
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="{% url 'churches:church_delete' church.pk %}">
                <i class="fas fa-trash me-2"></i> Delete Church
            </a></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .info-card {
        border-left: 4px solid #007bff;
        transition: transform 0.2s ease-in-out;
    }
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .contact-card {
        border-left: 4px solid #28a745;
    }
    .leadership-card {
        border-left: 4px solid #dc3545;
    }
    .details-card {
        border-left: 4px solid #6f42c1;
    }
    .activity-card {
        border-left: 4px solid #fd7e14;
    }
    .primary-contact-badge {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
        font-weight: bold;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        display: inline-block;
    }
    .role-badge {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }
    .pastor-role {
        background-color: #dc3545;
        color: white;
    }
    .leadership-role {
        background-color: #fd7e14;
        color: white;
    }
    .member-role {
        background-color: #6c757d;
        color: white;
    }
    .field-row {
        border-bottom: 1px solid #f8f9fa;
        padding: 0.75rem 0;
    }
    .field-row:last-child {
        border-bottom: none;
    }
    .field-label {
        font-weight: 600;
        color: #495057;
        min-width: 140px;
    }
    .field-value {
        color: #212529;
    }
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Basic Information Card -->
        <div class="card info-card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-church me-2 text-primary"></i>Basic Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Church Name:</span>
                                <span class="field-value">{{ church.name|default:church.contact.church_name|default:"Not specified" }}</span>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Denomination:</span>
                                <span class="field-value">{{ church.denomination|default:"Not specified" }}</span>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Year Founded:</span>
                                <span class="field-value">{{ church.year_founded|default:"Not specified" }}</span>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Primary Language:</span>
                                <span class="field-value">{{ church.primary_language|default:"Not specified" }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Website:</span>
                                <span class="field-value">
                                    {% if church.website %}
                                        <a href="{{ church.website }}" target="_blank" class="text-decoration-none">
                                            <i class="fas fa-external-link-alt me-1"></i>{{ church.website }}
                                        </a>
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Location:</span>
                                <span class="field-value">{{ church.location|default:"Not specified" }}</span>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Congregation Size:</span>
                                <span class="field-value">{{ church.congregation_size|default:"Not specified" }}</span>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Weekly Attendance:</span>
                                <span class="field-value">{{ church.weekly_attendance|default:"Not specified" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information Card -->
        <div class="card contact-card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-address-card me-2 text-success"></i>Contact Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Email:</span>
                                <span class="field-value">
                                    {% if church.contact.email %}
                                        <a href="#" onclick="openEmailCompose('{{ church.contact.email }}', '{{ church.name|default:church.contact.church_name }}', {{ church.contact.id }})" class="text-decoration-none">
                                            <i class="fas fa-envelope me-1"></i>{{ church.contact.email }}
                                        </a>
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="d-flex justify-content-between">
                                <span class="field-label">Phone:</span>
                                <span class="field-value">
                                    {% if church.contact.phone %}
                                        <a href="#" onclick="handlePhoneClick('{{ church.contact.phone }}', {{ church.contact.id }})" class="text-decoration-none">
                                            <i class="fas fa-phone me-1"></i>{{ church.contact.phone }}
                                        </a>
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="field-row">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="field-label">Address:</span>
                                <span class="field-value text-end">
                                    {% if church.contact.full_address %}
                                        <address class="mb-0">
                                            {% if church.contact.street_address %}{{ church.contact.street_address }}<br>{% endif %}
                                            {% if church.contact.city or church.contact.state or church.contact.zip_code %}
                                                {{ church.contact.city }}{% if church.contact.city and church.contact.state %}, {% endif %}
                                                {{ church.contact.state }} {{ church.contact.zip_code }}<br>
                                            {% endif %}
                                            {% if church.contact.country and church.contact.country != 'United States' %}{{ church.contact.country }}{% endif %}
                                        </address>
                                        <a href="https://maps.google.com/?q={{ church.contact.full_address|urlencode }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                                            <i class="fas fa-map-marker-alt"></i> View on Map
                                        </a>
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Church Details Card -->
        <div class="card details-card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2 text-purple"></i>Church Details
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {% if church.service_times %}
                        <div class="field-row">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="field-label">Service Times:</span>
                                <span class="field-value text-end">
                                    {% if church.service_times %}
                                        <ul class="list-unstyled mb-0">
                                            {% for service in church.service_times %}
                                                <li>{{ service }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if church.secondary_languages %}
                        <div class="field-row">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="field-label">Other Languages:</span>
                                <span class="field-value text-end">
                                    {% for lang in church.secondary_languages %}
                                        <span class="badge bg-light text-dark me-1">{{ lang }}</span>
                                    {% endfor %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if church.ministries %}
                        <div class="field-row">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="field-label">Ministries:</span>
                                <span class="field-value text-end">
                                    {% if church.ministries %}
                                        <ul class="list-unstyled mb-0">
                                            {% for ministry in church.ministries %}
                                                <li><small>{{ ministry }}</small></li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if church.facilities %}
                        <div class="field-row">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="field-label">Facilities:</span>
                                <span class="field-value text-end">
                                    {% if church.facilities %}
                                        <ul class="list-unstyled mb-0">
                                            {% for facility in church.facilities %}
                                                <li><small>{{ facility }}</small></li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% if church.contact.notes or church.info_given %}
                <div class="mt-3 pt-3 border-top">
                    <div class="field-row">
                        <span class="field-label d-block mb-2">Notes:</span>
                        <div class="field-value">
                            {% if church.contact.notes %}
                                <div class="mb-2">
                                    <strong>General Notes:</strong>
                                    <p class="mb-0">{{ church.contact.notes|linebreaks }}</p>
                                </div>
                            {% endif %}
                            {% if church.info_given %}
                                <div>
                                    <strong>Information Given:</strong>
                                    <p class="mb-0">{{ church.info_given|linebreaks }}</p>
                                </div>
                            {% endif %}
                            {% if not church.contact.notes and not church.info_given %}
                                <span class="text-muted">No notes available.</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Communications -->
        <div class="card activity-card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-comments me-2 text-warning"></i>Recent Communications
                </h5>
                <a href="/communications/?contact_id={{ church.contact.id }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-list"></i> View All
                </a>
            </div>
            <div class="card-body">
                {% if recent_communications %}
                    <div class="list-group">
                        {% for communication in recent_communications %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ communication.subject|default:"No Subject" }}</h6>
                                    <small class="text-muted">{{ communication.date|date:"M d, Y" }}</small>
                                </div>
                                <p class="mb-1">{{ communication.message|truncatechars:150|default:"No message content" }}</p>
                                <small class="text-muted">
                                    <span class="badge bg-secondary">{{ communication.type|default:"Communication" }}</span>
                                    {% if communication.sender %}
                                        by {{ communication.sender }}
                                    {% endif %}
                                </small>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-comment-slash fa-3x mb-3"></i>
                        <p>No communications recorded yet.</p>
                        <a href="/communications/gmail/compose/?recipient={{ church.contact.email }}&name={{ church.name|default:church.contact.church_name }}&contact_id={{ church.contact.id }}" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send First Email
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Statistics Card -->
        <div class="card stats-card mb-4">
            <div class="card-body text-center">
                <h5 class="card-title text-white mb-3">
                    <i class="fas fa-chart-bar me-2"></i>Quick Stats
                </h5>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h3 text-white mb-0">{{ church.memberships.count }}</div>
                        <small class="text-white-50">People</small>
                    </div>
                    <div class="col-6">
                        <div class="h3 text-white mb-0">{{ recent_communications|length }}</div>
                        <small class="text-white-50">Communications</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Card -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-flag me-2"></i>Status
                </h5>
            </div>
            <div class="card-body">
                <div class="field-row">
                    <div class="d-flex justify-content-between">
                        <span class="field-label">Pipeline Stage:</span>
                        <span class="field-value">
                            {% with stage_code=church.contact.get_pipeline_stage_code %}
                                {% if stage_code == 'promotion' %}
                                    <span class="badge bg-info">Promotion</span>
                                {% elif stage_code == 'information' %}
                                    <span class="badge bg-secondary">Information</span>
                                {% elif stage_code == 'invitation' %}
                                    <span class="badge bg-primary">Invitation</span>
                                {% elif stage_code == 'confirmation' %}
                                    <span class="badge bg-warning text-dark">Confirmation</span>
                                {% elif stage_code == 'automation' %}
                                    <span class="badge bg-success">Automation</span>
                                {% elif stage_code == 'en42' %}
                                    <span class="badge bg-success">EN42</span>
                                {% else %}
                                    <span class="text-muted">No stage assigned</span>
                                {% endif %}
                            {% endwith %}
                        </span>
                    </div>
                </div>
                <div class="field-row">
                    <div class="d-flex justify-content-between">
                        <span class="field-label">Priority:</span>
                        <span class="field-value">
                            {% if church.contact.priority == 'high' %}
                                <span class="badge bg-danger">High</span>
                            {% elif church.contact.priority == 'medium' %}
                                <span class="badge bg-warning text-dark">Medium</span>
                            {% elif church.contact.priority == 'low' %}
                                <span class="badge bg-success">Low</span>
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="field-row">
                    <div class="d-flex justify-content-between">
                        <span class="field-label">Assigned To:</span>
                        <span class="field-value">
                            {% if church.contact.user %}
                                {{ church.contact.user.full_name|default:church.contact.user.email }}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="field-row">
                    <div class="d-flex justify-content-between">
                        <span class="field-label">Office:</span>
                        <span class="field-value">
                            {% if church.contact.office %}
                                {{ church.contact.office.name }}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- People & Contacts Card -->
        <div class="card leadership-card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2 text-danger"></i>People & Contacts
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="addChurchMember()">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
            <div class="card-body">
                {% if church.memberships.all %}
                    <div class="list-group list-group-flush">
                        {% for membership in church.memberships.all %}
                            <div class="list-group-item px-0 py-2">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <h6 class="mb-0">
                                                <a href="{% url 'contacts:person_detail' membership.person.pk %}" class="text-decoration-none">
                                                    {{ membership.person.name }}
                                                </a>
                                            </h6>
                                            {% if membership.is_primary_contact %}
                                                <span class="primary-contact-badge">
                                                    <i class="fas fa-star me-1"></i>Primary Contact
                                                </span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-2">
                                            <span class="badge role-badge {% if membership.is_pastor %}pastor-role{% elif membership.is_leadership %}leadership-role{% else %}member-role{% endif %}">
                                                {{ membership.get_role_display }}
                                            </span>
                                            {% if membership.status != 'active' %}
                                                <span class="badge bg-secondary">{{ membership.get_status_display }}</span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="small text-muted">
                                            {% if membership.person.contact.email %}
                                                <div>
                                                    <a href="#" onclick="openEmailCompose('{{ membership.person.contact.email }}', '{{ membership.person.name }}', {{ membership.person.contact.id }})" class="text-decoration-none">
                                                        <i class="fas fa-envelope me-1"></i>{{ membership.person.contact.email }}
                                                    </a>
                                                </div>
                                            {% endif %}
                                            {% if membership.person.contact.phone %}
                                                <div>
                                                    <a href="#" onclick="handlePhoneClick('{{ membership.person.contact.phone }}', {{ membership.person.contact.id }})" class="text-decoration-none">
                                                        <i class="fas fa-phone me-1"></i>{{ membership.person.contact.phone }}
                                                    </a>
                                                </div>
                                            {% endif %}
                                            {% if membership.start_date %}
                                                <div class="mt-1">
                                                    <i class="fas fa-calendar me-1"></i>Since {{ membership.start_date|date:"M Y" }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="{% url 'contacts:person_detail' membership.person.pk %}">
                                                <i class="fas fa-user me-2"></i>View Profile
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="editChurchMember({{ membership.pk }})">
                                                <i class="fas fa-edit me-2"></i>Edit Role
                                            </a></li>
                                            {% if not membership.is_primary_contact %}
                                            <li><a class="dropdown-item" href="#" onclick="setPrimaryContact({{ membership.pk }})">
                                                <i class="fas fa-star me-2"></i>Set as Primary
                                            </a></li>
                                            {% endif %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="removeChurchMember({{ membership.pk }})">
                                                <i class="fas fa-trash me-2"></i>Remove
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                {% if membership.notes %}
                                <div class="mt-2 p-2 bg-light rounded small">
                                    <strong>Notes:</strong> {{ membership.notes }}
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-user-slash fa-3x mb-3"></i>
                        <p>No people assigned to this church yet.</p>
                        <button class="btn btn-primary" onclick="addChurchMember()">
                            <i class="fas fa-plus"></i> Add First Person
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Metadata Card -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info me-2"></i>Metadata
                </h5>
            </div>
            <div class="card-body">
                <div class="field-row">
                    <div class="d-flex justify-content-between">
                        <span class="field-label">Created:</span>
                        <span class="field-value">{{ church.contact.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
                <div class="field-row">
                    <div class="d-flex justify-content-between">
                        <span class="field-label">Last Updated:</span>
                        <span class="field-value">{{ church.contact.updated_at|date:"M d, Y" }}</span>
                    </div>
                </div>
                <div class="field-row">
                    <div class="d-flex justify-content-between">
                        <span class="field-label">Created By:</span>
                        <span class="field-value">
                            {% if church.contact.user %}
                                {{ church.contact.user.full_name|default:church.contact.user.email }}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMemberModalLabel">Add Person to Church</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addMemberForm" method="post" action="{% url 'churches:add_church_member' church.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="personSelect" class="form-label">Select Person</label>
                        <select class="form-select" name="person" id="personSelect" required>
                            <option value="">Choose a person...</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="roleSelect" class="form-label">Role</label>
                        <select class="form-select" name="role" id="roleSelect" required>
                            <option value="member">Member</option>
                            <option value="senior_pastor">Senior Pastor</option>
                            <option value="associate_pastor">Associate Pastor</option>
                            <option value="youth_pastor">Youth Pastor</option>
                            <option value="worship_pastor">Worship Pastor</option>
                            <option value="missions_pastor">Missions Pastor</option>
                            <option value="admin_pastor">Administrative Pastor</option>
                            <option value="elder">Elder</option>
                            <option value="deacon">Deacon</option>
                            <option value="board_member">Board Member</option>
                            <option value="secretary">Secretary</option>
                            <option value="treasurer">Treasurer</option>
                            <option value="regular_attendee">Regular Attendee</option>
                            <option value="volunteer">Volunteer</option>
                            <option value="committee_member">Committee Member</option>
                            <option value="ministry_leader">Ministry Leader</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_primary_contact" id="isPrimaryContact">
                            <label class="form-check-label" for="isPrimaryContact">
                                Set as Primary Contact
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="memberNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" name="notes" id="memberNotes" rows="3" placeholder="Any additional notes about this person's role..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Person</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Handle email click - open Gmail compose in app
function openEmailCompose(email, name, contactId) {
    const composeUrl = `/communications/gmail/compose/?recipient=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}&contact_id=${contactId}`;
    window.location.href = composeUrl;
}

// Handle phone click - detect mobile and either dial or open communication log
function handlePhoneClick(phoneNumber, contactId) {
    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        window.location.href = `tel:${phoneNumber}`;
    } else {
        window.location.href = `/communications/?open_log_modal=phone&contact_id=${contactId}`;
    }
}

// Add church member
function addChurchMember() {
    // Load available people for the dropdown
    loadAvailablePeople();
    const modal = new bootstrap.Modal(document.getElementById('addMemberModal'));
    modal.show();
}

function loadAvailablePeople() {
    fetch('/communications/api/contacts/')
    .then(response => response.json())
    .then(data => {
        const personSelect = document.getElementById('personSelect');
        personSelect.innerHTML = '<option value="">Choose a person...</option>';
        data.people.forEach(person => {
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = person.name;
            personSelect.appendChild(option);
        });
    })
    .catch(error => {
        console.error('Error loading people:', error);
    });
}

// Edit church member
function editChurchMember(membershipId) {
    // TODO: Implement edit modal
    console.log('Edit member:', membershipId);
}

// Set primary contact
function setPrimaryContact(membershipId) {
    if (confirm('Set this person as the primary contact for this church?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/churches/membership/${membershipId}/set-primary/`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Remove church member
function removeChurchMember(membershipId) {
    if (confirm('Remove this person from the church? This will not delete the person, only their association with this church.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/churches/membership/${membershipId}/remove/`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}