{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Task List{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Task List</h2>
        <a href="{% url 'tasks:task_create' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create New Task
        </a>
    </div>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Filter Tasks</h5>
        </div>
        <div class="card-body">
            <form method="get" class="form-horizontal">
                {{ filter_form|crispy }}
                <div class="mt-3">
                    <button type="submit" class="btn btn-info btn-sm">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                    <a href="{% url 'tasks:task_list' %}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-times"></i> Clear Filters
                    </a>
                </div>
            </form>
        </div>
    </div>

    {% if tasks %}
        <div class="list-group">
            {% for task in page_obj %} {# Use page_obj for paginated tasks #}
                <div id="task-item-{{ task.pk }}" class="list-group-item list-group-item-action flex-column align-items-start {% if task.status == 'completed' %}task-completed{% endif %}">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div>
                            <a href="{{ task.get_absolute_url }}" class="text-decoration-none">
                                <h5 class="mb-1 {% if task.status == 'completed' %}text-decoration-line-through{% endif %}">{{ task.title }}</h5>
                            </a>
                            <small class="task-status-display">Status: {{ task.get_status_display }}</small> | 
                            <small>Priority: {{ task.get_priority_display }}</small>
                            {% if task.status == 'completed' and task.completed_at %}
                                <small class="text-muted task-completed-at-display"> | Completed: {{ task.completed_at|date:"Y-m-d" }}</small>
                            {% else %}
                                <small> | Due: {{ task.due_date|date:"Y-m-d"|default:"N/A" }}</small>
                            {% endif %}
                        </div>
                        <div>
                            {% if task.status != 'completed' %}
                            <button class="btn btn-sm btn-outline-success mark-complete-btn" data-task-id="{{ task.pk }}">
                                <i class="fas fa-check"></i> Complete
                            </button>
                            {% endif %}
                            <a href="{% url 'tasks:task_update' task.pk %}" class="btn btn-sm btn-outline-secondary ms-1"><i class="fas fa-edit"></i></a>
                        </div>
                    </div>
                    <p class="mb-1 mt-1">{{ task.description|truncatewords:20|default:"" }}</p_>
                    {% if task.assigned_to %}<small class="d-block text-muted">Assigned to: {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}</small>{% endif %}
                </div>
            {% endfor %}
        </div>

        {% include "partials/_pagination.html" %}

    {% else %}
        <div class="alert alert-info" role="alert">
            No tasks found.
            {% if request.GET %}
                Try adjusting your filters or <a href="{% url 'tasks:task_list' %}" class="alert-link">clear filters</a>.
            {% else %}
                <a href="{% url 'tasks:task_create' %}" class="alert-link">Create a new task?</a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.mark-complete-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const taskId = this.dataset.taskId;
            const url = `/tasks/${taskId}/complete/`;
            const taskItem = document.getElementById(`task-item-${taskId}`);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (taskItem) {
                        taskItem.classList.add('task-completed');
                        const titleEl = taskItem.querySelector('h5');
                        if (titleEl) titleEl.classList.add('text-decoration-line-through');
                        
                        const statusEl = taskItem.querySelector('.task-status-display');
                        if(statusEl) statusEl.textContent = `Status: ${data.status}`;

                        const completedAtEl = taskItem.querySelector('.task-completed-at-display');
                        if(completedAtEl && data.completed_at_formatted) {
                            completedAtEl.textContent = ` | Completed: ${data.completed_at_formatted}`;
                            completedAtEl.classList.remove('d-none'); // Ensure it's visible
                        } else if (completedAtEl) {
                             // If it exists but no date, create or update it
                            let smallCompletedText = taskItem.querySelector('.task-completed-at-display');
                            if (!smallCompletedText) { // If it doesn't exist, find where to insert or append
                                const statusPriorityContainer = taskItem.querySelector('.task-status-display').parentNode;
                                if(statusPriorityContainer && data.completed_at_formatted) {
                                   statusPriorityContainer.insertAdjacentHTML('beforeend', `<small class="text-muted task-completed-at-display"> | Completed: ${data.completed_at_formatted}</small>`);
                                }
                            }
                        }
                    }
                    this.remove(); // Remove the button
                } else {
                    alert('Failed to mark task as complete: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error marking task complete:', error);
                alert('An error occurred while marking the task as complete.');
            });
        });
    });
});
</script>
{% endblock %}